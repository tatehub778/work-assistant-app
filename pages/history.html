<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ç›®ç«‹ãŸã›ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .record-card {
            margin-bottom: 15px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .user-icon {
            font-size: 20px;
        }

        .user-name {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .category-badge {
            font-size: 14px;
            color: #7f8c8d;
        }

        .timestamp {
            text-align: right;
            font-size: 12px;
            color: #95a5a6;
        }

        .card-body {
            padding-left: 5px;
        }

        .detail-label {
            font-weight: bold;
        }

        .btn-edit {
            background: #f1f2f6;
            border: 1px solid #dcdde1;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #2f3542;
        }

        .btn-edit:hover {
            background: #dfe4ea;
        }
    </style>
</head>

<body>
    <div class="container">
        <nav class="nav-bar">
            <a href="../index.html">
                <span class="back-arrow">â†</span>
                æˆ»ã‚‹
            </a>
        </nav>

        <div class="form-container">
            <h1 class="page-title">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h1>

            <!-- è¡¨ç¤ºæ–¹æ³•é¸æŠ -->
            <div class="form-group">
                <label>è¡¨ç¤ºæ–¹æ³•</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;">
                        <input type="radio" name="viewMode" value="date" checked style="margin-right: 5px;">
                        ğŸ“… æ—¥ä»˜ã”ã¨
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;">
                        <input type="radio" name="viewMode" value="user" style="margin-right: 5px;">
                        ğŸ‘¤ äººã”ã¨
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;">
                        <input type="radio" name="viewMode" value="category" style="margin-right: 5px;">
                        ğŸ“‹ ã‚«ãƒ†ã‚´ãƒªã”ã¨
                    </label>
                </div>
                <label>ä¸¦ã³é †</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;">
                        <input type="radio" name="sortOrder" value="desc" checked style="margin-right: 5px;">
                        â¬‡ï¸ æ–°ã—ã„é †
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; white-space: nowrap;">
                        <input type="radio" name="sortOrder" value="asc" style="margin-right: 5px;">
                        â¬†ï¸ å¤ã„é †
                    </label>
                </div>
            </div>

            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <div style="padding: 20px; background: #f8f9fa; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 18px;">ğŸ” çµã‚Šè¾¼ã¿æ¡ä»¶</h3>

                <div class="form-group">
                    <label for="filterUser">ğŸ‘¤ ç¤¾å“¡ã§çµã‚Šè¾¼ã¿</label>
                    <select id="filterUser">
                        <option value="all">å…¨å“¡</option>
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="filterCategory">ğŸ“‹ ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§çµã‚Šè¾¼ã¿</label>
                    <select id="filterCategory">
                        <option value="all">å…¨ã¦è¡¨ç¤º</option>
                        <option value="é…åˆ»æ—©é€€">é…åˆ»/æ—©é€€</option>
                        <option value="æœ‰çµ¦ç”³è«‹">æœ‰çµ¦ç”³è«‹</option>
                        <option value="ä»£ä¼‘ç”³è«‹">ä»£ä¼‘ç”³è«‹</option>
                        <option value="ä½œæ¥­å ±å‘Š">ä½œæ¥­å ±å‘Š</option>
                        <option value="å¤œå‹¤ç”³è«‹">å¤œå‹¤ç”³è«‹</option>
                        <option value="å¤œå‹¤ãƒ¡ãƒ³ãƒãƒ¼æŒ‡ç¤º">å¤œå‹¤ãƒ¡ãƒ³ãƒãƒ¼æŒ‡ç¤º</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="filterDateFrom">ğŸ“… æœŸé–“ã§çµã‚Šè¾¼ã¿ï¼ˆé–‹å§‹æ—¥ï¼‰</label>
                    <input type="date" id="filterDateFrom">
                </div>

                <div class="form-group">
                    <label for="filterDateTo">ğŸ“… æœŸé–“ã§çµã‚Šè¾¼ã¿ï¼ˆçµ‚äº†æ—¥ï¼‰</label>
                    <input type="date" id="filterDateTo">
                </div>

                <button type="button" class="btn btn-secondary" id="clearFiltersBtn" style="margin-top: 10px;">ğŸ”„
                    ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
            </div>

            <div id="recordCount" class="alert alert-info">
                èª­ã¿è¾¼ã¿ä¸­...
            </div>

            <div id="dataList">
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </div>

            <a href="../index.html" class="btn btn-back mt-20">æˆ»ã‚‹</a>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div class="modal-content"
            style="background: white; margin: 20px auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; max-height: 90vh; overflow-y: auto;">
            <h2>ğŸ“ ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£</h2>
            <form id="editForm">
                <input type="hidden" id="editId">
                <input type="hidden" id="editKey">

                <div class="form-group">
                    <label>æ°å</label>
                    <select id="editUserName" required></select>
                </div>

                <!-- å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                <div id="editFields"></div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæœˆã®ç¯„å›²ã‚’è¨­å®š
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

        document.getElementById('filterDateFrom').valueAsDate = firstDayOfMonth;
        document.getElementById('filterDateTo').valueAsDate = lastDayOfMonth;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’æ§‹ç¯‰
        function buildUserFilter() {
            const allData = getAllData();
            const users = new Set();

            // ç™»éŒ²æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
            const savedUsers = JSON.parse(localStorage.getItem('user_list') || '[]');
            savedUsers.forEach(u => users.add(u));

            // ãƒ‡ãƒ¼ã‚¿å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚è¿½åŠ ï¼ˆå¿µã®ãŸã‚ï¼‰
            allData.forEach(record => {
                if (record.userName) {
                    users.add(record.userName);
                }
            });

            const select = document.getElementById('filterUser');
            select.innerHTML = '<option value="all">å…¨å“¡</option>';

            Array.from(users).sort().forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                select.appendChild(option);
            });
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        function getAllData() {
            // ã‚­ãƒ¼ã”ã¨ã«å–å¾—ã—ã€ã‚½ãƒ¼ã‚¹å…ƒã®ã‚­ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹
            const keys = [STORAGE_KEYS.ATTENDANCE, STORAGE_KEYS.WORK_REPORTS, STORAGE_KEYS.NIGHT_SHIFTS, STORAGE_KEYS.TEAM_INSTRUCTIONS];
            let all = [];
            keys.forEach(key => {
                const data = getData(key).map(item => {
                    // ã‚«ãƒ†ã‚´ãƒªè£œæ­£ãƒ­ã‚¸ãƒƒã‚¯: ã€Œå‹¤æ€ ã€ã«ãªã£ã¦ã—ã¾ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¸­èº«ã§åˆ¤åˆ¥
                    if (item.category === 'å‹¤æ€ ' || !item.category) {
                        if (item.leaveDate) item.category = 'ä»£ä¼‘ç”³è«‹';
                        else if (item.startDate || (item.days && item.reason)) item.category = 'æœ‰çµ¦ç”³è«‹';
                        else if (item.type || item.minutes) item.category = 'é…åˆ»æ—©é€€';
                    }
                    return { ...item, _sourceKey: key };
                });
                all = all.concat(data);
            });
            return all;
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterData() {
            let allData = getAllData();

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const filterUser = document.getElementById('filterUser').value;
            if (filterUser !== 'all') {
                allData = allData.filter(record => record.userName === filterUser);
            }

            // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const filterCategory = document.getElementById('filterCategory').value;
            if (filterCategory !== 'all') {
                allData = allData.filter(record => record.category === filterCategory);
            }

            // æ—¥ä»˜ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const filterDateFrom = document.getElementById('filterDateFrom').value;
            const filterDateTo = document.getElementById('filterDateTo').value;

            if (filterDateFrom || filterDateTo) {
                allData = allData.filter(record => {
                    const recordDate = new Date(record.timestamp);
                    const recordDateOnly = new Date(recordDate.getFullYear(), recordDate.getMonth(), recordDate.getDate());

                    if (filterDateFrom && filterDateTo) {
                        const fromDate = new Date(filterDateFrom);
                        const toDate = new Date(filterDateTo);
                        return recordDateOnly >= fromDate && recordDateOnly <= toDate;
                    } else if (filterDateFrom) {
                        const fromDate = new Date(filterDateFrom);
                        return recordDateOnly >= fromDate;
                    } else if (filterDateTo) {
                        const toDate = new Date(filterDateTo);
                        return recordDateOnly <= toDate;
                    }
                    return true;
                });
            }

            return allData;
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        function clearFilters() {
            document.getElementById('filterUser').value = 'all';
            document.getElementById('filterCategory').value = 'all';

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæœˆã®ç¯„å›²ã‚’è¨­å®š
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

            document.getElementById('filterDateFrom').valueAsDate = firstDayOfMonth;
            document.getElementById('filterDateTo').valueAsDate = lastDayOfMonth;

            displayData();
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        function displayData() {
            console.log('displayData called');
            const viewMode = document.querySelector('input[name="viewMode"]:checked').value;
            const sortOrder = document.querySelector('input[name="sortOrder"]:checked').value;
            console.log('ViewMode:', viewMode, 'SortOrder:', sortOrder);

            const filteredData = filterData();
            const dataList = document.getElementById('dataList');

            // ä»¶æ•°è¡¨ç¤º
            document.getElementById('recordCount').textContent = `è¡¨ç¤ºä»¶æ•°: ${filteredData.length}ä»¶`;

            dataList.innerHTML = '';

            if (filteredData.length === 0) {
                dataList.innerHTML = '<div class="alert alert-warning">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            if (viewMode === 'date') {
                displayByDate(filteredData, sortOrder);
            } else if (viewMode === 'user') {
                displayByUser(filteredData, sortOrder);
            } else if (viewMode === 'category') {
                displayByCategory(filteredData, sortOrder);
            }
        }

        // æ—¥ä»˜ã”ã¨ã«è¡¨ç¤º
        function displayByDate(data, sortOrder) {
            // æ—¥ä»˜ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedByDate = {};

            data.forEach(record => {
                const recordDate = new Date(record.timestamp);
                const dateKey = `${recordDate.getFullYear()}/${String(recordDate.getMonth() + 1).padStart(2, '0')}/${String(recordDate.getDate()).padStart(2, '0')}`;

                if (!groupedByDate[dateKey]) {
                    groupedByDate[dateKey] = [];
                }
                groupedByDate[dateKey].push(record);
            });

            // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
            let sortedDates = Object.keys(groupedByDate).sort();
            if (sortOrder === 'desc') {
                sortedDates = sortedDates.reverse();
            }

            sortedDates.forEach(date => {
                const section = document.createElement('div');
                section.innerHTML = `
                    <h3 style="margin-top: 20px; padding: 10px; background: #4A90E2; color: white; border-radius: 8px;">
                        ğŸ“… ${date}ï¼ˆ${groupedByDate[date].length}ä»¶ï¼‰
                    </h3>
                `;

                // ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚‚ã‚½ãƒ¼ãƒˆï¼ˆå¿µã®ãŸã‚ï¼‰
                groupedByDate[date].sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
                });

                groupedByDate[date].forEach(record => {
                    const card = createRecordCard(record);
                    section.appendChild(card);
                });

                document.getElementById('dataList').appendChild(section);
            });
        }

        // äººã”ã¨ã«è¡¨ç¤º
        function displayByUser(data, sortOrder) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedByUser = {};

            data.forEach(record => {
                const user = record.userName || 'æœªè¨­å®š';

                if (!groupedByUser[user]) {
                    groupedByUser[user] = [];
                }
                groupedByUser[user].push(record);
            });

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
            Object.keys(groupedByUser).sort().forEach(user => {
                const section = document.createElement('div');
                section.innerHTML = `
                    <h3 style="margin-top: 20px; padding: 10px; background: #F5A623; color: white; border-radius: 8px;">
                        ğŸ‘¤ ${user}ï¼ˆ${groupedByUser[user].length}ä»¶ï¼‰
                    </h3>
                `;

                // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
                groupedByUser[user].sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
                });

                groupedByUser[user].forEach(record => {
                    const card = createRecordCard(record);
                    section.appendChild(card);
                });

                document.getElementById('dataList').appendChild(section);
            });
        }

        // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«è¡¨ç¤º
        function displayByCategory(data, sortOrder) {
            // ã‚«ãƒ†ã‚´ãƒªã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const groupedByCategory = {};

            data.forEach(record => {
                const category = record.category || 'æœªåˆ†é¡';

                if (!groupedByCategory[category]) {
                    groupedByCategory[category] = [];
                }
                groupedByCategory[category].push(record);
            });

            // ã‚«ãƒ†ã‚´ãƒªã§ã‚½ãƒ¼ãƒˆã—ã¦è¡¨ç¤º
            const categoryOrder = ['é…åˆ»æ—©é€€', 'æœ‰çµ¦ç”³è«‹', 'ä»£ä¼‘ç”³è«‹', 'ä½œæ¥­å ±å‘Š', 'å¤œå‹¤ç”³è«‹', 'å¤œå‹¤ãƒ¡ãƒ³ãƒãƒ¼æŒ‡ç¤º'];
            const sortedCategories = Object.keys(groupedByCategory).sort((a, b) => {
                const indexA = categoryOrder.indexOf(a);
                const indexB = categoryOrder.indexOf(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });

            sortedCategories.forEach(category => {
                const section = document.createElement('div');
                section.innerHTML = `
                    <h3 style="margin-top: 20px; padding: 10px; background: #667eea; color: white; border-radius: 8px;">
                        ğŸ“‹ ${category}ï¼ˆ${groupedByCategory[category].length}ä»¶ï¼‰
                    </h3>
                `;

                // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
                groupedByCategory[category].sort((a, b) => {
                    const dateA = new Date(a.timestamp);
                    const dateB = new Date(b.timestamp);
                    return sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
                });

                groupedByCategory[category].forEach(record => {
                    const card = createRecordCard(record);
                    section.appendChild(card);
                });

                document.getElementById('dataList').appendChild(section);
            });
        }

        // ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
        function createRecordCard(record) {
            const card = document.createElement('div');
            card.className = 'alert alert-info record-card';
            card.innerHTML = formatRecord(record);
            return card;
        }

        // ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatRecord(record) {
            const userName = record.userName || 'æœªè¨­å®š';
            const category = record.category;
            const timestamp = new Date(record.timestamp).toLocaleString('ja-JP');

            // ã‚«ãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‰
            let html = `
                <div class="card-header">
                    <div>
                        <div class="user-info">
                            <span class="user-icon">ğŸ‘¤</span>
                            <span class="user-name">${userName}</span>
                            <button class="btn-edit" onclick='openEditModal(${JSON.stringify(record).replace(/'/g, "&#39;")})'>âœï¸ ä¿®æ­£</button>
                        </div>
                        <div class="category-badge">
                            <strong>ã€${category}ã€‘</strong>
                        </div>
                    </div>
                    <div class="timestamp">
                        ${timestamp}
                    </div>
                </div>
            `;

            // ã‚«ãƒ¼ãƒ‰æœ¬ä½“ï¼ˆè©³ç´°æƒ…å ±ï¼‰
            html += '<div class="card-body">';

            switch (record.category) {
                case 'é…åˆ»æ—©é€€':
                    html += `<span class="detail-label">ç¨®åˆ¥:</span> ${record.type}<br>`;
                    html += `<span class="detail-label">æ—¥ä»˜:</span> ${formatDate(record.date)}<br>`;
                    html += `<span class="detail-label">æ™‚é–“:</span> ${record.minutes}åˆ†<br>`;
                    html += `<span class="detail-label">ç†ç”±:</span> ${record.reason}`;
                    break;

                case 'æœ‰çµ¦ç”³è«‹':
                    if (record.startDate === record.endDate) {
                        html += `<span class="detail-label">æ—¥ä»˜:</span> ${formatDate(record.startDate)}<br>`;
                    } else {
                        html += `<span class="detail-label">æœŸé–“:</span> ${formatDate(record.startDate)} ã€œ ${formatDate(record.endDate)}<br>`;
                    }
                    html += `<span class="detail-label">æ—¥æ•°:</span> ${record.days}æ—¥<br>`;
                    html += `<span class="detail-label">ç†ç”±:</span> ${record.reason}`;
                    break;

                case 'ä»£ä¼‘ç”³è«‹':
                    html += `<span class="detail-label">ä»£ä¼‘å–å¾—æ—¥:</span> ${formatDate(record.leaveDate)}`;
                    if (record.days) {
                        // 0.5ãªã‚‰åŠä¼‘ã€ãã‚Œä»¥å¤–ã¯æ—¥æ•°
                        const daysText = record.days === 0.5 ? '0.5æ—¥ (åŠä¼‘)' : `${record.days}æ—¥`;
                        html += ` <strong>[${daysText}]</strong>`;
                    }
                    html += `<br>`;
                    html += `<span class="detail-label">ä¼‘æ—¥å‡ºå‹¤æ—¥:</span> ${formatDate(record.workDate)}<br>`;
                    if (record.note) {
                        html += `<span class="detail-label">å‚™è€ƒ:</span> ${record.note}`;
                    }
                    break;

                case 'ä½œæ¥­å ±å‘Š':
                    html += `<span class="detail-label">ä½œæ¥­æ—¥:</span> ${formatDate(record.workDate)}<br>`;
                    html += `<span class="detail-label">ç¾å ´:</span> ${record.siteName}<br>`;
                    html += `<span class="detail-label">ä½œæ¥­å†…å®¹:</span> ${record.workContent}<br>`;
                    if (record.members) {
                        html += `<span class="detail-label">ãƒ¡ãƒ³ãƒãƒ¼:</span> ${record.members}<br>`;
                    }
                    if (record.notes) {
                        html += `<span class="detail-label">å‚™è€ƒ:</span> ${record.notes}`;
                    }
                    break;

                case 'å¤œå‹¤ç”³è«‹':
                    html += `<span class="detail-label">å¤œå‹¤æ—¥:</span> ${formatDate(record.shiftDate)}<br>`;
                    if (record.managementNumber) {
                        html += `<span class="detail-label">ç®¡ç†ç•ªå·:</span> ${record.managementNumber}<br>`;
                    }
                    html += `<span class="detail-label">ç¾å ´:</span> ${record.siteName}<br>`;
                    html += `<span class="detail-label">æ™‚é–“:</span> ${record.workStartTime} ã€œ ${record.siteLeaveTime}<br>`;
                    html += `<span class="detail-label">ä½œæ¥­å†…å®¹:</span> ${record.workContent}<br>`;

                    if (record.members && Array.isArray(record.members)) {
                        html += `<span class="detail-label">ãƒ¡ãƒ³ãƒãƒ¼:</span><br>`;
                        record.members.forEach(m => {
                            let memberInfo = `ã€€ãƒ»${m.name}`;
                            const details = [];

                            // ç¾å ´å‰æ®‹æ¥­
                            if (m.preSiteOvertime && m.preSiteOvertime.hasOvertime) {
                                let preText = 'ç¾å ´å‰æ®‹æ¥­ã‚ã‚Š';
                                if (m.preSiteOvertime.startTime && m.preSiteOvertime.endTime) {
                                    preText += `(${m.preSiteOvertime.startTime}ã€œ${m.preSiteOvertime.endTime})`;
                                }
                                details.push(preText);
                            }

                            // ç¾å ´æ®‹æ¥­
                            if (m.overtime && m.overtime > 0) {
                                details.push(`ç¾å ´æ®‹æ¥­${m.overtime}h`);
                            }

                            if (details.length > 0) {
                                memberInfo += ` [${details.join(', ')}]`;
                            }
                            html += memberInfo + '<br>';
                        });
                    } else {
                        html += `<span class="detail-label">ãƒ¡ãƒ³ãƒãƒ¼:</span> ${record.members}<br>`;
                    }

                    if (record.notes) {
                        html += `<span class="detail-label">å‚™è€ƒ:</span> ${record.notes}`;
                    }
                    break;

                case 'å¤œå‹¤ãƒ¡ãƒ³ãƒãƒ¼æŒ‡ç¤º':
                    html += `<span class="detail-label">ä½œæ¥­æ—¥:</span> ${formatDate(record.date)}<br>`;
                    html += `<span class="detail-label">æŒ‡ç¤ºå†…å®¹:</span><br>`;
                    record.instructions.forEach(inst => {
                        const parts = [];
                        if (inst.early > 0) parts.push(`æ—©å‡º${inst.early}æ™‚é–“`);
                        if (inst.overtime > 0) parts.push(`æ®‹æ¥­${inst.overtime}æ™‚é–“`);
                        if (parts.length === 0) parts.push('é€šå¸¸å‹¤å‹™');
                        html += `ã€€ãƒ»${inst.member}: ${parts.join('ã€')}<br>`;
                    });
                    break;

                case 'å‹¤æ€ ': // æ±ç”¨ãƒ»ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒãšã‚Œã¦ã—ã¾ã£ãŸå ´åˆãªã©ï¼‰
                default:
                    if (record.type) html += `<span class="detail-label">ç¨®åˆ¥:</span> ${record.type}<br>`;
                    if (record.detail) html += `<span class="detail-label">è©³ç´°:</span> ${record.detail}<br>`;
                    if (record.reason) html += `<span class="detail-label">ç†ç”±:</span> ${record.reason}<br>`;
                    if (record.note) html += `<span class="detail-label">å‚™è€ƒ:</span> ${record.note}<br>`;
                    if (record.workContent) html += `<span class="detail-label">å†…å®¹:</span> ${record.workContent}<br>`;

                    // æ—¥ä»˜ã‚‰ã—ãã‚‚ã®ã‚’æ¢ã—ã¦è¡¨ç¤º
                    const dateField = record.date || record.startDate || record.workDate || record.shiftDate || record.leaveDate;
                    if (dateField) {
                        html += `<span class="detail-label">æ—¥ä»˜:</span> ${formatDate(dateField)}<br>`;
                    }
                    break;
            }

            html += '</div>';

            return html;
        }

        // åˆæœŸåŒ–
        buildUserFilter();
        displayData();

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
            radio.addEventListener('change', displayData);
        });
        document.querySelectorAll('input[name="sortOrder"]').forEach(radio => {
            radio.addEventListener('change', displayData);
        });
        document.getElementById('filterUser').addEventListener('change', displayData);
        document.getElementById('filterCategory').addEventListener('change', displayData);
        document.getElementById('filterDateFrom').addEventListener('change', displayData);
        document.getElementById('filterDateTo').addEventListener('change', displayData);
        document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

        // ==========================================
        // ç·¨é›†æ©Ÿèƒ½
        // ==========================================

        const modal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');

        function closeEditModal() {
            modal.style.display = 'none';
        }

        function openEditModal(record) {
            document.getElementById('editId').value = record.id;
            document.getElementById('editKey').value = record._sourceKey;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠè‚¢ç”Ÿæˆ
            const userSelect = document.getElementById('editUserName');
            userSelect.innerHTML = '';
            const users = JSON.parse(localStorage.getItem('user_list') || '[]');
            // ãƒ‡ãƒ¼ã‚¿å†…ã®æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚è¿½åŠ 
            if (!users.includes(record.userName)) users.push(record.userName);

            users.forEach(u => {
                const op = document.createElement('option');
                op.value = u;
                op.textContent = u;
                userSelect.appendChild(op);
            });
            userSelect.value = record.userName;

            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”Ÿæˆ
            const fieldsContainer = document.getElementById('editFields');
            fieldsContainer.innerHTML = '';

            let html = '';

            // æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (å…±é€šã§ã‚ã‚‹å ´åˆãŒå¤šã„)
            if (record.date) {
                html += createInput('date', 'date', 'æ—¥ä»˜', record.date);
            }
            if (record.startDate) {
                html += createInput('date', 'startDate', 'é–‹å§‹æ—¥', record.startDate);
            }
            if (record.endDate) {
                html += createInput('date', 'endDate', 'çµ‚äº†æ—¥', record.endDate);
            }
            if (record.leaveDate) {
                html += createInput('date', 'leaveDate', 'ä»£ä¼‘å–å¾—æ—¥', record.leaveDate);
            }
            if (record.workDate) {
                html += createInput('date', 'workDate', 'å‡ºå‹¤æ—¥/ä½œæ¥­æ—¥', record.workDate);
            }
            if (record.shiftDate) {
                html += createInput('date', 'shiftDate', 'å¤œå‹¤æ—¥', record.shiftDate);
            }

            // æ™‚é–“ãƒ»æ•°å€¤
            if (record.minutes) {
                html += createInput('number', 'minutes', 'æ™‚é–“(åˆ†)', record.minutes);
            }
            if (record.days) {
                html += createInput('number', 'days', 'æ—¥æ•°', record.days, 'step="0.5"');
            }

            // ãƒ†ã‚­ã‚¹ãƒˆãƒ»é¸æŠ
            if (record.category === 'é…åˆ»æ—©é€€' && record.type) {
                html += `<div class="form-group"><label>ç¨®åˆ¥</label><select name="type" class="edit-input" style="width:100%;padding:8px;"><option value="é…åˆ»">é…åˆ»</option><option value="æ—©é€€">æ—©é€€</option><option value="ä¸­æŠœã‘">ä¸­æŠœã‘</option></select></div>`;
                // å€¤è¨­å®šã¯å¾Œã§
                setTimeout(() => {
                    const sel = fieldsContainer.querySelector('[name="type"]');
                    if (sel) sel.value = record.type;
                }, 0);
            }

            if (record.reason) {
                html += createInput('text', 'reason', 'ç†ç”±', record.reason);
            }
            if (record.note) {
                html += createInput('text', 'note', 'å‚™è€ƒ', record.note);
            }
            if (record.notes) {
                html += createInput('text', 'notes', 'å‚™è€ƒ', record.notes);
            }
            if (record.workContent) {
                html += createInput('text', 'workContent', 'ä½œæ¥­å†…å®¹', record.workContent);
            }
            if (record.siteName) {
                html += createInput('text', 'siteName', 'ç¾å ´å', record.siteName);
            }

            fieldsContainer.innerHTML = html;

            modal.style.display = 'block';
        }

        function createInput(type, name, label, value, attrs = '') {
            return `
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display:block; margin-bottom: 5px;">${label}</label>
                    <input type="${type}" name="${name}" value="${value || ''}" class="edit-input" style="width: 100%; padding: 8px; box-sizing: border-box;" ${attrs}>
                </div>
            `;
        }

        editForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const key = document.getElementById('editKey').value;
            const userName = document.getElementById('editUserName').value;

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            const updates = { userName: userName };
            const inputs = document.querySelectorAll('.edit-input');
            inputs.forEach(input => {
                let val = input.value;
                if (input.type === 'number') val = parseFloat(val);
                updates[input.name] = val;
            });

            if (updateData(key, id, updates)) {
                alert('ä¿®æ­£ã—ã¾ã—ãŸ');
                closeEditModal();
                displayData(); // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
            } else {
                alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function (event) {
            if (event.target == modal) {
                closeEditModal();
            }
        }
    </script>
</body>

</html>