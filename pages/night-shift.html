<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤œå‹¤å ±å‘Šä½œæˆ (v1.1)</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .member-overtime-section {
            background: #f0f8ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #4A90E2;
        }

        .member-overtime-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .draft-selection {
            background: #fff3cd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 2px solid #ffc107;
        }

        #previewArea {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f0f0f0;
            margin-top: 20px;
        }

        #nightShiftTemplate {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 15mm;
            box-sizing: border-box;
            margin: 0 auto;
            font-family: 'Meiryo', 'Yu Gothic', 'Hiragino Kaku Gothic Pro', sans-serif;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .timeline-cell {
            flex: 1;
            height: 100%;
            border-right: 1px solid #000;
            box-sizing: border-box;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    </style>
</head>

<body>
    <div class="container">
        <nav class="nav-bar">
            <a href="../index.html">
                <span class="back-arrow">â†</span>
                æˆ»ã‚‹
            </a>
        </nav>

        <div class="form-container">
            <h1 class="page-title">ğŸ“‹ å¤œå‹¤ç”³è«‹ã‚·ãƒ¼ãƒˆ</h1>

            <div class="alert alert-info">
                ğŸ’¡ å‡ºç™ºå‰ã«åŸºæœ¬æƒ…å ±ã‚’è¨˜å…¥ã—ã€Œå‡ºç™ºå‰ä¿å­˜ã€ã€‚å‹¤å‹™çµ‚äº†å¾Œã¯ä¸‹æ›¸ãã‚’é¸æŠã—ã¦å®Ÿéš›ã®æ™‚é–“ã‚’è¨˜å…¥ã—ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€â†’ã€Œæœ€çµ‚ä¿å­˜ã€ã—ã¦ãã ã•ã„ã€‚
            </div>

            <!-- ä¸‹æ›¸ãé¸æŠ -->
            <div id="draftSelection" class="draft-selection" style="display: none;">
                <h3 style="margin-top: 0;">ğŸ“ å‡ºç™ºå‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</h3>
                <select id="draftList" class="form-control">
                    <option value="">-- ä¸‹æ›¸ãã‚’é¸æŠ --</option>
                </select>
                <button type="button" class="btn btn-secondary" id="loadDraft" style="margin-top: 10px;">èª­ã¿è¾¼ã¿</button>
                <button type="button" class="btn btn-back" id="newEntry" style="margin-top: 10px;">æ–°è¦å…¥åŠ›</button>
            </div>

            <form id="nightShiftForm">
                <!-- ç®¡ç†ç•ªå· -->
                <div class="form-group">
                    <label for="managementNumber">ç®¡ç†ç•ªå·</label>
                    <input type="text" id="managementNumber" placeholder="ä¾‹: NS-20241203-001">
                </div>

                <!-- åŸºæœ¬æƒ…å ± -->
                <div class="form-group">
                    <label for="shiftDate">å¤œå‹¤æ—¥</label>
                    <input type="date" id="shiftDate" required>
                </div>

                <div class="form-group">
                    <label for="client">å…ƒè«‹ã‘</label>
                    <input type="text" id="client" placeholder="ä¾‹: ã‚¨ã‚¤ã‚¸ãƒ³ã‚°æ ª" required>
                </div>

                <div class="form-group">
                    <label for="siteName">ç¾å ´å</label>
                    <input type="text" id="siteName" placeholder="ä¾‹: ã‚¢ãƒ¡ãƒªãƒ¼" required>
                </div>

                <div class="form-group">
                    <label for="location">å ´æ‰€</label>
                    <input type="text" id="location" placeholder="ä¾‹: ã‚¹ã‚¿ã‚¸ã‚ªã‚¹ã‚±ãƒ«ãƒˆãƒ³" required>
                </div>

                <div class="form-group">
                    <label for="manager">æ‹…å½“è€…</label>
                    <input type="text" id="manager" placeholder="ä¾‹: å°å±±æ§˜" required>
                </div>

                <div class="form-group">
                    <label for="workContent">ä½œæ¥­å†…å®¹</label>
                    <textarea id="workContent" rows="4" placeholder="ä¾‹: å†…è£…å·¥äº‹ã€ãƒ•ãƒ­ãƒ¼ãƒªãƒ³ã‚°æ–½å·¥" required></textarea>
                </div>

                <!-- æ™‚é–“æƒ…å ± -->
                <h3>â° æ™‚é–“æƒ…å ±</h3>
                <div class="form-group">
                    <label for="departureTime">å‡ºç™ºäºˆå®šæ™‚åˆ»</label>
                    <input type="time" id="departureTime" value="18:00" required>
                </div>

                <div class="form-group">
                    <label for="workStartTime">ä½œæ¥­é–‹å§‹æ™‚åˆ»ï¼ˆç¾å ´åˆ°ç€ï¼‰</label>
                    <input type="time" id="workStartTime" value="20:00" required>
                </div>

                <div class="form-group">
                    <label for="siteLeaveTime">ç¾å ´çµ‚äº†æ™‚åˆ»ï¼ˆç¾å ´å‡ºç™ºï¼‰</label>
                    <input type="time" id="siteLeaveTime" value="23:00" required>
                </div>

                <div class="form-group">
                    <label for="returnTime">å¸°ç¤¾äºˆå®šæ™‚åˆ»</label>
                    <input type="time" id="returnTime" value="24:00" required>
                </div>

                <div class="form-group">
                    <label for="supervisor">ç®¡ç†è€…</label>
                    <input type="text" id="supervisor" placeholder="ä¾‹: ç”°ä¸­" required>
                </div>

                <!-- ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ± -->
                <h3>ğŸ‘¥ ä½œæ¥­ãƒ¡ãƒ³ãƒãƒ¼</h3>
                <div class="form-group">
                    <label for="memberCount">è‡ªç¤¾äºˆå®šäººæ•°</label>
                    <input type="number" id="memberCount" min="1" value="4" required>
                    <button type="button" class="btn btn-secondary" id="updateMembers"
                        style="margin-top: 5px;">ãƒ¡ãƒ³ãƒãƒ¼æ¬„ã‚’ç”Ÿæˆ</button>
                </div>

                <div id="memberInputs">
                    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                </div>

                <div class="form-group">
                    <label for="notes">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
                    <textarea id="notes" rows="3" placeholder="ç‰¹è¨˜äº‹é …ã‚„æ³¨æ„ç‚¹ãªã©"></textarea>
                </div>

                <button type="button" class="btn btn-primary" id="previewBtn">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                <button type="button" class="btn btn-primary" id="savePreDeparture">ğŸš— å‡ºç™ºå‰ä¿å­˜ã—ã¦LINEç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
                <button type="button" class="btn btn-primary" id="saveFinal" style="display: none;">âœ…
                    æœ€çµ‚ä¿å­˜ã—ã¦LINEç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
                <button type="button" class="btn btn-secondary" id="generatePDFBtn" style="display: none;">ğŸ“„
                    PDFç”Ÿæˆ</button>
                <button type="button" class="btn btn-secondary" id="generatePNGBtn" style="display: none;">ğŸ–¼ï¸
                    PNGç”Ÿæˆ</button>
                <a href="../index.html" class="btn btn-back">æˆ»ã‚‹</a>
            </form>

            <div id="instructionBox" class="alert alert-warning" style="display: none; margin-top: 20px;">
                <h3>ğŸ“‹ æ¬¡ã®æ‰‹é †ã§å¤œå‹¤ç”³è«‹ã‚’å®Œäº†ã—ã¦ãã ã•ã„</h3>
                <p><strong>LINEã«æŠ•ç¨¿ã™ã‚‹æ–‡ç« ã¯ã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã¾ã™ï¼</strong></p>
            </div>

            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div id="previewArea" style="display: none;">
                <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div class="alert alert-warning">
                    ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã¦ã€å•é¡Œãªã‘ã‚Œã°PDFã¾ãŸã¯PNGã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚<br>
                    â€»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ã€‚
                </div>
                <div id="templateContainer"></div>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        let currentDraftId = null;

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        document.getElementById('shiftDate').valueAsDate = new Date();

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¸‹æ›¸ãä¸€è¦§ã‚’è¡¨ç¤º
        window.addEventListener('DOMContentLoaded', () => {
            loadDraftList();
            updateMemberInputs();
        });

        // ä¸‹æ›¸ãä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        function loadDraftList() {
            const drafts = getDrafts().filter(d => d.status === 'pre-departure');
            const select = document.getElementById('draftList');
            select.innerHTML = '<option value="">-- ä¸‹æ›¸ãã‚’é¸æŠ --</option>';

            drafts.forEach(draft => {
                const option = document.createElement('option');
                option.value = draft.id;
                option.textContent = `${formatDate(draft.shiftDate)} - ${draft.siteName}`;
                select.appendChild(option);
            });

            if (drafts.length > 0) {
                document.getElementById('draftSelection').style.display = 'block';
            }
        }

        // ä¸‹æ›¸ãã‚’èª­ã¿è¾¼ã¿
        document.getElementById('loadDraft').addEventListener('click', () => {
            const draftId = document.getElementById('draftList').value;
            if (!draftId) {
                alert('ä¸‹æ›¸ãã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const draft = getDraft(parseInt(draftId));
            if (draft) {
                currentDraftId = draft.id;

                // ãƒ•ã‚©ãƒ¼ãƒ ã«èª­ã¿è¾¼ã¿
                document.getElementById('managementNumber').value = draft.managementNumber || '';
                document.getElementById('shiftDate').value = draft.shiftDate;
                document.getElementById('client').value = draft.client || '';
                document.getElementById('siteName').value = draft.siteName;
                document.getElementById('location').value = draft.location || '';
                document.getElementById('manager').value = draft.manager || '';
                document.getElementById('workContent').value = draft.workContent;
                document.getElementById('departureTime').value = draft.departureTime || '18:00';
                document.getElementById('workStartTime').value = draft.workStartTime || '20:00';
                document.getElementById('siteLeaveTime').value = draft.siteLeaveTime || '23:00';
                document.getElementById('returnTime').value = draft.returnTime || '24:00';
                document.getElementById('supervisor').value = draft.supervisor || '';
                document.getElementById('memberCount').value = draft.memberCount || 1;
                document.getElementById('notes').value = draft.notes || '';

                // ãƒ¡ãƒ³ãƒãƒ¼å…¥åŠ›æ¬„ã‚’å†ç”Ÿæˆ
                updateMemberInputs();

                // ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                if (draft.members) {
                    setTimeout(() => {
                        draft.members.forEach((member, index) => {
                            const nameInput = document.querySelectorAll('.member-name')[index];
                            const breakInput = document.querySelectorAll('.member-break')[index];
                            const siteStartInput = document.querySelectorAll('.member-site-start')[index];
                            const siteEndInput = document.querySelectorAll('.member-site-end')[index];
                            const breakStartInput = document.querySelectorAll('.member-break-start')[index];
                            const breakEndInput = document.querySelectorAll('.member-break-end')[index];

                            if (nameInput) nameInput.value = member.name || '';
                            if (siteStartInput) siteStartInput.value = member.siteStart || document.getElementById('workStartTime').value || '';
                            if (siteEndInput) siteEndInput.value = member.siteEnd || document.getElementById('siteLeaveTime').value || '';
                            if (breakStartInput) breakStartInput.value = member.breakStart || '';
                            if (breakEndInput) breakEndInput.value = member.breakEnd || '';

                            // ç¾å ´å‰æ®‹æ¥­
                            if (member.preSiteOvertime && member.preSiteOvertime.hasOvertime) {
                                const checkbox = document.getElementById(`overtime_${member.name}`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    toggleOvertimeFields(member.name);

                                    document.getElementById(`location_${member.name}`).value = member.preSiteOvertime.location || '';
                                    document.getElementById(`start_${member.name}`).value = member.preSiteOvertime.startTime || '';
                                    document.getElementById(`end_${member.name}`).value = member.preSiteOvertime.endTime || '';
                                    document.getElementById(`breakStart_${member.name}`).value = member.preSiteOvertime.breakStart || '';
                                    document.getElementById(`breakEnd_${member.name}`).value = member.preSiteOvertime.breakEnd || '';
                                }
                            }
                        });
                    }, 100);
                }

                document.getElementById('draftSelection').style.display = 'none';
                alert('âœ… å‡ºç™ºå‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚å®Ÿéš›ã®ä½œæ¥­æ™‚é–“ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // æ–°è¦å…¥åŠ›
        document.getElementById('newEntry').addEventListener('click', () => {
            document.getElementById('draftSelection').style.display = 'none';
            currentDraftId = null;
        });

        // ãƒ¡ãƒ³ãƒãƒ¼å…¥åŠ›æ¬„ã‚’å‹•çš„ç”Ÿæˆ
        function updateMemberInputs() {
            const count = parseInt(document.getElementById('memberCount').value) || 0;
            const container = document.getElementById('memberInputs');

            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'form-group member-overtime-section';
                memberDiv.style.marginBottom = '20px';

                memberDiv.innerHTML = `
                    <h4>ãƒ¡ãƒ³ãƒãƒ¼ ${i + 1}</h4>
                    <div class="form-group">
                        <label>åå‰</label>
                        <input type="text" class="member-name" placeholder="ä¾‹: ç”°ä¸­" required>
                    </div>

                    <div style="margin-bottom: 15px;">
                         <label style="cursor: pointer; display: inline-flex; align-items: center;">
                            <input type="checkbox" class="member-direct-return" style="margin-right: 5px;"> ç›´å¸°
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label>ç¾å ´é–‹å§‹</label>
                            <input type="time" class="member-site-start">
                        </div>
                        <div style="flex: 1;">
                            <label>ç¾å ´çµ‚äº†</label>
                            <input type="time" class="member-site-end">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <div style="flex: 1;">
                            <label>ä¼‘æ†©é–‹å§‹</label>
                            <input type="time" class="member-break-start">
                        </div>
                        <div style="flex: 1;">
                            <label>ä¼‘æ†©çµ‚äº†</label>
                            <input type="time" class="member-break-end">
                        </div>
                    </div>

                    <div class="member-overtime-header" style="margin-top: 15px;">
                        <label>
                            <input type="checkbox" class="member-preSite-checkbox" onchange="toggleOvertimeFields('member_${i}')">
                            ç¾å ´å‰æ®‹æ¥­ã‚ã‚Š
                        </label>
                    </div>
                    <div id="fields_member_${i}" style="display: none; margin-left: 20px;">
                        <div class="form-group">
                            <label>å ´æ‰€</label>
                            <select class="member-preSite-location">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="å·¥å ´">å·¥å ´</option>
                                <option value="äº‹å‹™æ‰€">äº‹å‹™æ‰€</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">
                                <label>é–‹å§‹æ™‚åˆ»</label>
                                <input type="time" class="member-preSite-start">
                            </div>
                            <div style="flex: 1;">
                                <label>çµ‚äº†æ™‚åˆ»</label>
                                <input type="time" class="member-preSite-end">
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <div style="flex: 1;">
                                <label>ä¼‘æ†©é–‹å§‹</label>
                                <input type="time" class="member-preSite-breakStart">
                            </div>
                            <div style="flex: 1;">
                                <label>ä¼‘æ†©çµ‚äº†</label>
                                <input type="time" class="member-preSite-breakEnd">
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(memberDiv);

                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ã‚»ãƒƒãƒˆ
                const startInputs = memberDiv.querySelectorAll('.member-site-start');
                const endInputs = memberDiv.querySelectorAll('.member-site-end');
                if (startInputs.length > 0) startInputs[0].value = document.getElementById('workStartTime').value;
                if (endInputs.length > 0) endInputs[0].value = document.getElementById('siteLeaveTime').value;
            }
        }

        function toggleOvertimeFields(memberId) {
            const checkbox = event.target;
            const fields = document.getElementById(`fields_${memberId}`);
            if (fields) {
                fields.style.display = checkbox.checked ? 'block' : 'none';
            }
        }

        // ãƒ¡ãƒ³ãƒãƒ¼æ•°å¤‰æ›´æ™‚
        document.getElementById('memberCount').addEventListener('change', updateMemberInputs);
        document.getElementById('updateMembers').addEventListener('click', updateMemberInputs);

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        function collectFormData(status) {
            const members = [];
            const memberNames = document.querySelectorAll('.member-name');
            // const memberBreaks = document.querySelectorAll('.member-break'); // å»ƒæ­¢
            const memberSiteStarts = document.querySelectorAll('.member-site-start');
            const memberSiteEnds = document.querySelectorAll('.member-site-end');
            const memberDirectReturns = document.querySelectorAll('.member-direct-return');
            const memberBreakStarts = document.querySelectorAll('.member-break-start');
            const memberBreakEnds = document.querySelectorAll('.member-break-end');

            const preSiteCheckboxes = document.querySelectorAll('.member-preSite-checkbox');
            const preSiteLocations = document.querySelectorAll('.member-preSite-location');
            const preSiteStarts = document.querySelectorAll('.member-preSite-start');
            const preSiteEnds = document.querySelectorAll('.member-preSite-end');
            const preSiteBreakStarts = document.querySelectorAll('.member-preSite-breakStart');
            const preSiteBreakEnds = document.querySelectorAll('.member-preSite-breakEnd');

            memberNames.forEach((nameInput, index) => {
                const preSiteOvertime = preSiteCheckboxes[index].checked ? {
                    hasOvertime: true,
                    location: preSiteLocations[index].value,
                    startTime: preSiteStarts[index].value,
                    endTime: preSiteEnds[index].value,
                    breakStart: preSiteBreakStarts[index].value,
                    breakEnd: preSiteBreakEnds[index].value
                } : { hasOvertime: false };

                // ä¼‘æ†©æ™‚é–“ã®è‡ªå‹•è¨ˆç®—
                let calculatedBreakTime = 0;
                const bStart = memberBreakStarts[index].value;
                const bEnd = memberBreakEnds[index].value;
                if (bStart && bEnd) {
                    const diff = timeToMinutes(bEnd) - timeToMinutes(bStart);
                    if (diff > 0) calculatedBreakTime = diff;
                }

                members.push({
                    name: nameInput.value,
                    breakTime: calculatedBreakTime, // è‡ªå‹•è¨ˆç®—å€¤ã‚’ä½¿ç”¨
                    siteStart: memberSiteStarts[index].value,
                    siteEnd: memberSiteEnds[index].value,
                    breakStart: memberBreakStarts[index].value,
                    breakEnd: memberBreakEnds[index].value,
                    preSiteOvertime: preSiteOvertime,
                    directReturn: memberDirectReturns[index] ? memberDirectReturns[index].checked : false
                });
            });

            return {
                managementNumber: document.getElementById('managementNumber').value,
                shiftDate: document.getElementById('shiftDate').value,
                client: document.getElementById('client').value,
                siteName: document.getElementById('siteName').value,
                location: document.getElementById('location').value,
                manager: document.getElementById('manager').value,
                workContent: document.getElementById('workContent').value,
                departureTime: document.getElementById('departureTime').value,
                workStartTime: document.getElementById('workStartTime').value,
                siteLeaveTime: document.getElementById('siteLeaveTime').value,
                returnTime: document.getElementById('returnTime').value,
                supervisor: document.getElementById('supervisor').value,
                memberCount: document.getElementById('memberCount').value,
                members: members,
                notes: document.getElementById('notes').value,
                status: status,
                category: 'å¤œå‹¤ç”³è«‹'
            };
        }

        // LINEç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
        function generateLineText(data) {
            let lineText = `ã€å¤œå‹¤ç”³è«‹${data.status === 'final' ? 'ï¼ˆæœ€çµ‚ï¼‰' : 'ï¼ˆå‡ºç™ºå‰ï¼‰'}ã€‘\n`;

            if (data.managementNumber) {
                lineText += `ç®¡ç†ç•ªå·: ${data.managementNumber}\n`;
            }

            lineText += `æ—¥ä»˜: ${formatDate(data.shiftDate)}\n`;
            lineText += `ç¾å ´: ${data.siteName}\n`;
            lineText += `ç®¡ç†è€…: ${data.supervisor}\n`; // ç®¡ç†è€…ã‚’è¿½åŠ 

            if (data.status === 'pre-departure' || data.status === 'draft') {
                // å‡ºç™ºå‰ï¼ˆç°¡æ˜“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
                lineText += `ä½œæ¥­äºˆå®šæ™‚é–“: ${data.workStartTime} ã€œ ${data.siteLeaveTime}\n`;

                const memberNames = data.members.map(m => m.name).join('ã€');
                lineText += `ä½œæ¥­äºˆå®šè€…: ${memberNames}`;
            } else {
                // æœ€çµ‚ï¼ˆè©³ç´°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
                lineText += `\nã€ä½œæ¥­è©³ç´°ã€‘\n`;

                data.members.forEach(m => {
                    // æ™‚é–“è¨ˆç®— (è©³ç´°ãƒ­ã‚¸ãƒƒã‚¯)
                    let preSiteGrossHours = 0;
                    let preSiteNetHours = 0;
                    let preSiteBreakMinutes = 0;

                    if (m.preSiteOvertime && m.preSiteOvertime.hasOvertime) {
                        const preStart = m.preSiteOvertime.startTime;
                        const preEnd = m.preSiteOvertime.endTime;
                        if (preStart && preEnd) {
                            const [sH, sM] = preStart.split(':').map(Number);
                            const [eH, eM] = preEnd.split(':').map(Number);
                            let sMins = sH * 60 + sM;
                            let eMins = eH * 60 + eM;
                            if (eH < sH) eMins += 24 * 60;
                            const totalMins = eMins - sMins;

                            preSiteGrossHours = Math.round((totalMins / 60) * 10) / 10;

                            let netMins = totalMins;
                            if (m.preSiteOvertime.breakStart && m.preSiteOvertime.breakEnd) {
                                const [bsH, bsM] = m.preSiteOvertime.breakStart.split(':').map(Number);
                                const [beH, beM] = m.preSiteOvertime.breakEnd.split(':').map(Number);
                                const bMins = (beH * 60 + beM) - (bsH * 60 + bsM);
                                preSiteBreakMinutes = bMins;
                                netMins -= bMins;
                            }
                            preSiteNetHours = Math.round((netMins / 60) * 10) / 10;
                        }
                    }

                    let siteGrossHours = 0;
                    let siteNetHours = 0;
                    const siteBreakMinutes = parseInt(m.breakTime) || 0;

                    // ç¾å ´æ™‚é–“è¨ˆç®—ï¼ˆãƒ¡ãƒ³ãƒãƒ¼ã”ã¨ã®å…¥åŠ›å€¤ã‚’ä½¿ç”¨ï¼‰
                    const siteStartMins = timeToMinutes(m.siteStart);

                    // ç¾å ´çµ‚äº†æ™‚åˆ»ï¼ˆç›´å¸°ã®å ´åˆã¯ãã¡ã‚‰ã‚’å„ªå…ˆã€ã¾ãŸã¯å…¥åŠ›å€¤ï¼‰
                    // ã“ã“ã§ã¯å…¥åŠ›ã•ã‚ŒãŸ siteEnd ã‚’æ­£ã¨ã—ã€ç›´å¸°ã®å ´åˆã¯ãã‚ŒãŒå¸°ã‚‹æ™‚é–“ã§ã‚‚ã‚ã‚‹ã¨ã™ã‚‹
                    const siteEndMinsVal = timeToMinutes(m.siteEnd);

                    if (siteStartMins >= 0 && siteEndMinsVal >= 0) {
                        let endM = siteEndMinsVal;
                        // æ—¥è·¨ãå¯¾å¿œ
                        // timeToMinutesã®å®Ÿè£…ä¾å­˜ã ãŒã€é€šå¸¸ timeToMinutes ã¯ 17:00èµ·ç‚¹ã®åˆ†æ•°ã‚’è¿”ã™ã€‚
                        // å…¥åŠ›ãŒ "05:00" ãªã‚‰ç¿Œæ—¥æ‰±ã„ã«ãªã£ã¦ã„ã‚‹ã¯ãšã€‚
                        // ãŸã ã—ã€ã‚‚ã— siteStart < siteEnd ã¨ã„ã†å˜ç´”æ¯”è¼ƒã§é€†è»¢ã—ã¦ã„ãŸã‚‰ç¿Œæ—¥åŠ ç®—ãŒå¿…è¦ã‹ç¢ºèª
                        // timeToMinuteså†…ã§ 12:00ã‚ˆã‚Šå‰ã¯+24hã—ã¦ã„ã‚‹ãŸã‚ã€åŸºæœ¬çš„ã«ã¯å¤§å°æ¯”è¼ƒã§OK
                        if (endM < siteStartMins) {
                            // ã‚‚ã—ä½•ã‚‰ã‹ã®ç†ç”±ã§é€†è»¢ã—ã¦ã„ãŸã‚‰è£œæ­£ï¼ˆé€šå¸¸ã‚ã‚Šãˆãªã„ãŒå¿µã®ãŸã‚ï¼‰
                            // ã“ã“ã§ã¯ timeToMinutes ãŒæ­£ã—ãå‡¦ç†ã—ã¦ã„ã‚‹ã¨ä¿¡ã˜ã‚‹
                        }

                        const totalMins = endM - siteStartMins;
                        siteGrossHours = Math.round((totalMins / 60) * 10) / 10;
                        const netMins = totalMins - siteBreakMinutes;
                        siteNetHours = Math.round((netMins / 60) * 10) / 10;
                    }

                    const totalGross = Math.round((preSiteGrossHours + siteGrossHours) * 10) / 10;
                    const totalNet = Math.round((preSiteNetHours + siteNetHours) * 10) / 10;

                    // ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
                    lineText += `ãƒ»${m.name}`;
                    if (m.directReturn) lineText += ` (ç›´å¸°)`;

                    let parts = [];

                    // ç¾å ´å‰
                    if (preSiteGrossHours > 0) {
                        let str = `ç¾å ´å‰æ®‹æ¥­${preSiteGrossHours}h`;
                        if (preSiteGrossHours !== preSiteNetHours) {
                            str += `(ä¼‘æ†©æŠœã${preSiteNetHours}h)`;
                        }
                        if (preSiteBreakMinutes > 0) {
                            str += `ã€ä¼‘æ†©${preSiteBreakMinutes}åˆ†`;
                        }
                        parts.push(str);
                    }

                    // ç¾å ´
                    if (siteGrossHours > 0) {
                        let str = `ç¾å ´æ®‹æ¥­${siteGrossHours}h`;
                        if (siteGrossHours !== siteNetHours) {
                            str += `(ä¼‘æ†©æŠœã${siteNetHours}h)`;
                        }
                        if (siteBreakMinutes > 0) {
                            str += `ã€ä¼‘æ†©${siteBreakMinutes}åˆ†`;
                        }
                        parts.push(str);
                    }

                    if (parts.length > 0) {
                        lineText += ` ` + parts.join('ã€');
                        lineText += `ã€æ®‹æ¥­æ™‚é–“è¨ˆ${totalGross}h(ä¼‘æ†©æŠœã${totalNet}h)`;
                    }

                    lineText += `\n`;
                });

                if (data.notes) {
                    lineText += `\nå‚™è€ƒ: ${data.notes}`;
                }
            }

            return lineText;
        }

        // æ™‚é–“æ–‡å­—åˆ—ã‚’åˆ†ã«å¤‰æ›ï¼ˆ17:00ã‹ã‚‰ã®çµŒéåˆ†ï¼‰
        function timeToMinutes(timeStr) {
            if (!timeStr) return -1;
            const [h, m] = timeStr.split(':').map(Number);
            let minutes = h * 60 + m;

            // 17:00ã‚’0ã¨ã™ã‚‹
            // 12:00ã‚ˆã‚Šå‰ãªã‚‰ç¿Œæ—¥ã¨ã¿ãªã™ï¼ˆå¤œå‹¤ãªã®ã§ï¼‰
            if (h < 12) {
                minutes += 24 * 60;
            }

            return minutes - (17 * 60);
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
        async function generateTemplate(data) {
            const container = document.getElementById('templateContainer');
            container.innerHTML = '<div id="nightShiftTemplate"></div>';
            const template = document.getElementById('nightShiftTemplate');

            const date = new Date(data.shiftDate);
            const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;

            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®æ™‚é–“å¸¯ï¼ˆ17æ™‚ã€œ8æ™‚ï¼‰= 15æ™‚é–“ = 900åˆ†
            const totalMinutes = 15 * 60;
            const hours = [];
            for (let h = 17; h <= 23; h++) hours.push(h);
            for (let h = 0; h <= 8; h++) hours.push(h);

            // æ™‚é–“è¨ˆç®—
            const departureMins = timeToMinutes(data.departureTime);
            const workStartMins = timeToMinutes(data.workStartTime);
            const siteLeaveMins = timeToMinutes(data.siteLeaveTime);
            const returnMins = timeToMinutes(data.returnTime);

            // å„ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡Œã‚’ç”Ÿæˆ
            let memberTimelines = '';
            data.members.forEach((member) => {
                const breakStartMins = timeToMinutes(member.breakStart);
                const breakEndMins = timeToMinutes(member.breakEnd);

                // ç¾å ´å‰æ®‹æ¥­ã®æ™‚é–“è¨ˆç®—
                let preSiteGross = 0;
                let preSiteNet = 0;
                let preSiteBreak = 0;

                if (member.preSiteOvertime && member.preSiteOvertime.hasOvertime) {
                    const preSiteStart = member.preSiteOvertime.startTime;
                    const preSiteEnd = member.preSiteOvertime.endTime;
                    const preSiteBreakStart = member.preSiteOvertime.breakStart;
                    const preSiteBreakEnd = member.preSiteOvertime.breakEnd;

                    if (preSiteStart && preSiteEnd) {
                        const [startH, startM] = preSiteStart.split(':').map(Number);
                        const [endH, endM] = preSiteEnd.split(':').map(Number);
                        let startMins = startH * 60 + startM;
                        let endMins = endH * 60 + endM;
                        if (endH < startH) endMins += 24 * 60; // ç¿Œæ—¥

                        const totalMins = endMins - startMins;
                        preSiteGross = Math.round((totalMins / 60) * 10) / 10;

                        let netMins = totalMins;

                        // ä¼‘æ†©æ™‚é–“ã‚’å¼•ã
                        if (preSiteBreakStart && preSiteBreakEnd) {
                            const [bStartH, bStartM] = preSiteBreakStart.split(':').map(Number);
                            const [bEndH, bEndM] = preSiteBreakEnd.split(':').map(Number);
                            const breakMins = (bEndH * 60 + bEndM) - (bStartH * 60 + bStartM);
                            preSiteBreak = breakMins;
                            netMins -= breakMins;
                        }
                        preSiteNet = Math.round((netMins / 60) * 10) / 10;
                    }
                }

                // (å‰Šé™¤) const totalOvertimeHours ... ã¾ã  siteGross ãŒæœªå®šç¾©ã®ãŸã‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚ä¸‹ã§ totalGross ã¨ã—ã¦è¨ˆç®—ã—ã¦ã„ã‚‹ãŸã‚ä¸è¦ã€‚
                // ç¾å ´ã§ã®æ™‚é–“è¨ˆç®—
                let siteGross = 0;
                let siteNet = 0;
                const siteBreak = parseInt(member.breakTime) || 0;

                // ãƒ¡ãƒ³ãƒãƒ¼ã”ã¨ã®ç¾å ´é–‹å§‹ãƒ»çµ‚äº†ã‚’ä½¿ç”¨
                const mSiteStart = timeToMinutes(member.siteStart);
                const mSiteEnd = timeToMinutes(member.siteEnd);

                if (mSiteStart >= 0 && mSiteEnd >= 0) {
                    const totalMins = mSiteEnd - mSiteStart; // timeToMinutesãŒæ—¥è·¨ãå‡¦ç†æ¸ˆã¿
                    siteGross = Math.round((totalMins / 60) * 10) / 10;
                    const netMins = totalMins - siteBreak;
                    siteNet = Math.round((netMins / 60) * 10) / 10;
                }

                // æ®‹æ¥­æ™‚é–“åˆè¨ˆ
                const totalGross = Math.round((preSiteGross + siteGross) * 10) / 10;
                const totalNet = Math.round((preSiteNet + siteNet) * 10) / 10;

                // ãƒãƒ¼ç”Ÿæˆé–¢æ•°
                const createBar = (start, end, color) => {
                    if (start < 0 || end < 0 || start >= end) return '';
                    const left = (start / totalMinutes) * 100;
                    const width = ((end - start) / totalMinutes) * 100;
                    return `<div style="position: absolute; left: ${left}%; width: ${width}%; top: 2px; bottom: 2px; background-color: ${color}; z-index: 1;"></div>`;
                };

                // å·¥å ´/äº‹å‹™æ‰€è¡Œã®ãƒãƒ¼: ç¾å ´å‰æ®‹æ¥­
                let factoryBars = '';
                if (member.preSiteOvertime && member.preSiteOvertime.hasOvertime) {
                    const preSiteStartMins = timeToMinutes(member.preSiteOvertime.startTime);
                    const preSiteEndMins = timeToMinutes(member.preSiteOvertime.endTime);
                    if (preSiteStartMins >= 0 && preSiteEndMins >= 0) {
                        factoryBars += createBar(preSiteStartMins, preSiteEndMins, '#FFA500'); // ã‚ªãƒ¬ãƒ³ã‚¸è‰²
                    }
                }

                // ç¾å ´è¡Œã®ãƒãƒ¼
                let siteBars = '';

                // 1. å‡ºç™º -> ä½œæ¥­é–‹å§‹ (é»„è‰²)
                // ãƒãƒ¼è¡¨ç¤ºã«é–¢ã—ã¦ã¯ã€å…¨ä½“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ„Ÿã‚’ç¤ºã™ãŸã‚ Global Departure ã‚’ä½¿ã†ã‹ã€å„ãƒ¡ãƒ³ãƒãƒ¼ã®SiteStartã‚’ä½¿ã†ã‹ã€‚
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Œè©³ç´°æ™‚é–“ã€ã‚’æ±‚ã‚ã¦ã„ã‚‹ã®ã§ã€ãƒ¡ãƒ³ãƒãƒ¼å€‹åˆ¥ã®SiteStartã‚’ä½¿ã†ã¹ãã ãŒã€
                // ç§»å‹•æ™‚é–“(Departure->SiteStart)ãŒä¸æ˜ã«ãªã‚‹ã€‚
                // ã“ã“ã§ã¯ã€Œç¾å ´ä½œæ¥­ã€ã®ãƒãƒ¼ã‚’ãƒ¡ãƒ³ãƒãƒ¼å€‹åˆ¥ã® Start-End ã§æç”»ã™ã‚‹ã€‚
                // ç§»å‹•ã«ã¤ã„ã¦ã¯ã€ä»Šå›ã¯ã€ŒDeparture -> MemberSiteStartã€ã¨ä»®å®šã—ã¦æç”»ã—ã¦ã¿ã‚‹ã€‚

                // mSiteStart, mSiteEnd ã¯ä¸Šã§è¨ˆç®—æ¸ˆã¿

                // ç§»å‹•ï¼ˆè¡Œãï¼‰: Global Departure -> Member Site Start
                if (departureMins >= 0 && mSiteStart >= 0) {
                    siteBars += createBar(departureMins, mSiteStart, '#FFD700');
                }

                // ä½œæ¥­: Member Site Start -> Member Site End
                if (mSiteStart >= 0 && mSiteEnd >= 0) {
                    siteBars += createBar(mSiteStart, mSiteEnd, '#FFD700');
                }

                // ç§»å‹•ï¼ˆå¸°ã‚Šï¼‰: Member Site End -> Global Return (ç›´å¸°ã§ãªã„å ´åˆ)
                if (!member.directReturn && mSiteEnd >= 0 && returnMins >= 0) {
                    siteBars += createBar(mSiteEnd, returnMins, '#FFD700');
                }

                // (siteBars ã¯ä¸Šã§å®šç¾©æ¸ˆã¿)
                // ä¼‘æ†©: ä¼‘æ†©é–‹å§‹ -> ä¼‘æ†©çµ‚äº† (ç·‘è‰²ã€z-indexã‚’ä¸Šã’ã¦ä¸Šã«é‡ã­ã‚‹)
                if (breakStartMins >= 0 && breakEndMins >= 0) {
                    const left = (breakStartMins / totalMinutes) * 100;
                    const width = ((breakEndMins - breakStartMins) / totalMinutes) * 100;
                    siteBars += `<div style="position: absolute; left: ${left}%; width: ${width}%; top: 2px; bottom: 2px; background-color: #90EE90; z-index: 2;"></div>`;
                }

                // æ™‚é–“è»¸ã®ç›®ç››ã‚Šç·š
                let gridLines = '';
                for (let i = 0; i <= 15; i++) {
                    const left = (i / 15) * 100;
                    gridLines += `<div style="position: absolute; left: ${left}%; top: 0; bottom: 0; border-left: 1px solid #ccc; z-index: 0;"></div>`;
                }

                //  æ™‚é–“æƒ…å ±ã®è¡¨ç¤º
                let timeInfo = `<span style="font-weight: bold; width: 100px; font-size: 11px;">åå‰ ${member.name}</span>`;
                if (member.directReturn) {
                    timeInfo += `<span style="margin-left: 5px; font-size: 10px; color: #d9534f; border: 1px solid #d9534f; padding: 0 2px; border-radius: 2px;">ç›´å¸°</span>`;
                }

                if (preSiteGross > 0) {
                    timeInfo += `<span style="margin-left: 8px; font-size: 10px;">ç¾å ´å‰æ®‹æ¥­${preSiteGross}h</span>`;
                    if (preSiteGross !== preSiteNet) {
                        timeInfo += `<span style="font-size: 10px;">(ä¼‘æ†©æŠœã${preSiteNet}h)</span>`;
                    }
                    if (preSiteBreak > 0) {
                        timeInfo += `<span style="margin-left: 2px; font-size: 10px;">ã€ä¼‘æ†©${preSiteBreak}åˆ†</span>`;
                    }
                }

                if (siteGross > 0) {
                    timeInfo += `<span style="margin-left: 8px; font-size: 10px;">ç¾å ´æ®‹æ¥­${siteGross}h</span>`;
                    if (siteGross !== siteNet) {
                        timeInfo += `<span style="font-size: 10px;">(ä¼‘æ†©æŠœã${siteNet}h)</span>`;
                    }
                    if (siteBreak > 0) {
                        timeInfo += `<span style="margin-left: 2px; font-size: 10px;">ã€ä¼‘æ†©${siteBreak}åˆ†</span>`;
                    }
                }

                timeInfo += `<span style="margin-left: 10px; font-size: 11px; font-weight: bold;">æ®‹æ¥­æ™‚é–“è¨ˆ${totalGross}h(ä¼‘æ†©æŠœã${totalNet}h)</span>`;

                memberTimelines += `
                    <div style="margin-bottom: 25px; page-break-inside: avoid;">
                        <div style="display: flex; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #000; padding-bottom: 5px; flex-wrap: wrap;">
                            ${timeInfo}
                        </div>
                        
                        <div style="display: flex; align-items: center; height: 22px; border-bottom: 1px solid #000;">
                            <span style="width: 90px; font-size: 11px; padding-left: 5px;">å·¥å ´ äº‹å‹™æ‰€</span>
                            <div style="flex: 1; position: relative; height: 100%; border-left: 1px solid #000;">
                                ${gridLines}
                                ${factoryBars}
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; height: 22px; border-bottom: 1px solid #000;">
                            <span style="width: 90px; font-size: 11px; padding-left: 5px;">ç¾å ´</span>
                            <div style="flex: 1; position: relative; height: 100%; border-left: 1px solid #000;">
                                ${gridLines}
                                ${siteBars}
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; height: 18px;">
                            <span style="width: 90px; font-size: 9px;"></span>
                            <div style="flex: 1; display: flex;">
                                ${hours.map(h => `<div style="flex: 1; text-align: center; font-size: 9px;">${h}</div>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            template.innerHTML = `
                <div style="width: 100%; height: 100%; position: relative;">
                    <h2 style="text-align: center; margin-bottom: 15px; font-size: 18px; font-weight: bold;">${date.getFullYear()}å¹´ã€€å¤œå‹¤ç”³è«‹ã‚·ãƒ¼ãƒˆ</h2>

                    
                    <div style="font-size: 10px; text-align: right; margin-bottom: 8px; line-height: 1.3;">
                        ï¼Šäº‹å‰ã«E-netLINEã¸é€ã‚‹ã‚ˆã†ã«ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚<br>
                        ï¼Šèµ·ç¥¨ã¯å¸°ç¤¾æ™‚é–“ã€é€£çµ¡ã®å ´åˆã¯ç¾å ´çµ‚äº†æ™‚é–“ã«ã¦
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px;">
                        <tr>
                            <td style="padding: 5px; border: 1px solid #000; width: 11%; background: #f5f5f5;">æ—¥ä»˜</td>
                            <td style="padding: 5px; border: 1px solid #000; width: 18%;">${dateStr}</td>
                            <td style="padding: 5px; border: 1px solid #000; width: 11%; background: #f5f5f5;">å…ƒè«‹ã‘</td>
                            <td style="padding: 5px; border: 1px solid #000; width: 18%;">${data.client}</td>
                            <td style="padding: 5px; border: 1px solid #000; width: 11%; background: #f5f5f5;">æ‹…å½“è€…</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.manager}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">ç®¡ç†ç•ªå·</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.managementNumber || ''}</td>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">ç¾å ´å</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.siteName}</td>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">å ´æ‰€</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.location}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">å‡ºç™ºäºˆå®šæ™‚åˆ»</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.departureTime}</td>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">ä½œæ¥­é–‹å§‹æ™‚åˆ»</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.workStartTime}</td>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">å¸°ç¤¾äºˆå®šæ™‚åˆ»</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.returnTime}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">åˆè¨ˆä½œæ¥­äºˆå®šæ™‚é–“</td>
                            <td style="padding: 5px; border: 1px solid #000;">5æ™‚é–“00åˆ†ã€œ</td>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">ç®¡ç†è€…</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.supervisor}</td>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">è‡ªç¤¾äºˆå®šäººæ•°</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.memberCount}äºº</td>
                        </tr>
                    </table>

                    ${memberTimelines}

                    <div style="margin-top: 30px; font-size: 10px; color: #666; text-align: center; border-top: 1px solid #eee; padding-top: 10px;">
                        é€šä¿¡çŠ¶æ³ãªã©ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ã€å¾“æ¥é€šã‚Šæ‰‹å…ƒã®ç”³è«‹æ›¸PDFã«è¨˜å…¥ã—ã¦å ±å‘Šã—ã¦ãã ã•ã„ã€‚
                    </div>
                </div>
            `;
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³
        document.getElementById('previewBtn').addEventListener('click', async function () {
            try {
                if (!document.getElementById('nightShiftForm').checkValidity()) {
                    alert('å…¨ã¦ã®å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                const data = collectFormData('preview');
                await generateTemplate(data);

                document.getElementById('previewArea').style.display = 'block';
                document.getElementById('saveFinal').style.display = 'block';
                document.getElementById('generatePDFBtn').style.display = 'block';
                document.getElementById('generatePNGBtn').style.display = 'block';

                document.getElementById('previewArea').scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error(e);
                alert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
            }
        });

        // å‡ºç™ºå‰ä¿å­˜
        document.getElementById('savePreDeparture').addEventListener('click', function () {
            try {
                const data = collectFormData('pre-departure');

                // ä¸‹æ›¸ãã¨ã—ã¦ä¿å­˜
                if (currentDraftId) {
                    updateDraft(currentDraftId, data);
                } else {
                    currentDraftId = saveDraft(data);
                }

                const lineText = generateLineText(data);

                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(lineText)
                        .then(() => {
                            showCopySuccess();
                            document.getElementById('instructionBox').style.display = 'block';
                            document.getElementById('instructionBox').scrollIntoView({ behavior: 'smooth' });

                            // LINEã‚¢ãƒ—ãƒªèµ·å‹• (PCã§ã‚‚è©¦è¡Œ)
                            window.location.href = 'https://line.me/R/msg/text/?' + encodeURIComponent(lineText);
                        })
                        .catch(err => {
                            alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
                            // ã‚³ãƒ”ãƒ¼å¤±æ•—ã—ã¦ã‚‚LINEã¯é–‹ã
                            window.location.href = 'https://line.me/R/msg/text/?' + encodeURIComponent(lineText);
                        });
                } else {
                    // éHTTPSãªã©
                    alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã¯HTTPSç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚LINEèµ·å‹•ã®ã¿è©¦ã¿ã¾ã™ã€‚');
                    window.location.href = 'https://line.me/R/msg/text/?' + encodeURIComponent(lineText);
                }
            } catch (e) {
                console.error(e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
            }
        });

        // æœ€çµ‚ä¿å­˜
        document.getElementById('saveFinal').addEventListener('click', function () {
            try {
                const data = collectFormData('final');
                saveData(STORAGE_KEYS.NIGHT_SHIFTS, data);

                // ä¸‹æ›¸ãã‚’å‰Šé™¤
                if (currentDraftId) {
                    deleteDraft(currentDraftId);
                    currentDraftId = null;
                }

                const lineText = generateLineText(data);

                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‚³ãƒ”ãƒ¼
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(lineText)
                        .then(() => {
                            showCopySuccess();
                            alert('âœ… æœ€çµ‚ä¿å­˜ã—ã¾ã—ãŸï¼LINEç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');

                            // LINEã‚¢ãƒ—ãƒªèµ·å‹• (PCã§ã‚‚è©¦è¡Œ)
                            window.location.href = 'https://line.me/R/msg/text/?' + encodeURIComponent(lineText);
                        })
                        .catch(err => {
                            alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
                            // ã‚³ãƒ”ãƒ¼å¤±æ•—ã—ã¦ã‚‚LINEã¯é–‹ã
                            window.location.href = 'https://line.me/R/msg/text/?' + encodeURIComponent(lineText);
                        });
                } else {
                    alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã¯HTTPSç’°å¢ƒãŒå¿…è¦ã§ã™ã€‚LINEèµ·å‹•ã®ã¿è©¦ã¿ã¾ã™ã€‚');
                    window.location.href = 'https://line.me/R/msg/text/?' + encodeURIComponent(lineText);
                }
            } catch (e) {
                console.error(e);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
            }
        });

        // PDFç”Ÿæˆ
        document.getElementById('generatePDFBtn').addEventListener('click', async function () {
            const template = document.getElementById('nightShiftTemplate');

            try {
                window.scrollTo(0, 0);

                const canvas = await html2canvas(template, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save('å¤œå‹¤ç”³è«‹æ›¸.pdf');

                alert('âœ… PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ³ãªã©ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ã€å¾“æ¥é€šã‚Šæ‰‹å…ƒã®ç”³è«‹æ›¸PDFã«è¨˜å…¥ã—ã¦å ±å‘Šã—ã¦ãã ã•ã„ã€‚');
            }
        });

        // PNGç”Ÿæˆ
        document.getElementById('generatePNGBtn').addEventListener('click', async function () {
            const template = document.getElementById('nightShiftTemplate');

            try {
                window.scrollTo(0, 0);

                const canvas = await html2canvas(template, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                });

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'å¤œå‹¤ç”³è«‹æ›¸.png';
                    a.click();
                    URL.revokeObjectURL(url);

                    alert('âœ… PNGç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                });
            } catch (error) {
                console.error('PNGç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ PNGç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
    </script>
</body>

</html>