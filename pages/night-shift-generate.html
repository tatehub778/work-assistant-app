<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤œå‹¤ç”³è«‹æ›¸ç”Ÿæˆ</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        #previewArea {
            width: 100%;
            overflow-x: auto;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f0f0f0;
        }

        /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯A4ç¸¦ã‚µã‚¤ã‚ºã«å›ºå®š */
        #nightShiftTemplate {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 15mm;
            box-sizing: border-box;
            margin: 0 auto;
            font-family: 'MS Gothic', 'Meiryo', monospace;
            /* å°åˆ·æ™‚ã®èƒŒæ™¯è‰²ã‚’å¼·åˆ¶ */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ã‚»ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .timeline-cell {
            flex: 1;
            height: 100%;
            border-right: 1px solid #000;
            box-sizing: border-box;
            /* èƒŒæ™¯è‰²ã‚’å°åˆ·ã•ã›ã‚‹ãŸã‚ã®è¨­å®š */
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    </style>
</head>

<body>
    <div class="container">
        <nav class="nav-bar">
            <a href="../index.html">
                <span class="back-arrow">â†</span>
                æˆ»ã‚‹
            </a>
        </nav>

        <div class="form-container">
            <h1 class="page-title">ğŸ“‹ å¤œå‹¤ç”³è«‹æ›¸ç”Ÿæˆ</h1>

            <div class="alert alert-info">
                ğŸ’¡ å¤œå‹¤æƒ…å ±ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ç”³è«‹æ›¸PDFã¾ãŸã¯PNGç”»åƒã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™
            </div>

            <button type="button" class="btn btn-secondary" id="fillSampleBtn"
                style="margin-bottom: 20px; background-color: #28a745;">
                ğŸ§ª ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ç¢ºèª
            </button>

            <form id="nightShiftGenerateForm">
                <div class="form-group">
                    <label for="shiftDate">å¤œå‹¤æ—¥ä»˜</label>
                    <input type="date" id="shiftDate" required>
                </div>

                <div class="form-group">
                    <label for="client">å…ƒè«‹ã‘</label>
                    <input type="text" id="client" placeholder="ä¾‹: ã‚¨ã‚¤ã‚¸ãƒ³ã‚°æ ª" required>
                </div>

                <div class="form-group">
                    <label for="siteName">ç¾å ´å</label>
                    <input type="text" id="siteName" placeholder="ä¾‹: ã‚¢ãƒ¡ãƒªãƒ¼" required>
                </div>

                <div class="form-group">
                    <label for="location">å ´æ‰€</label>
                    <input type="text" id="location" placeholder="ä¾‹: ã‚¹ã‚¿ã‚¸ã‚ªã‚¹ã‚±ãƒ«ãƒˆãƒ³" required>
                </div>

                <div class="form-group">
                    <label for="manager">æ‹…å½“è€…</label>
                    <input type="text" id="manager" placeholder="ä¾‹: å°å±±æ§˜" required>
                </div>

                <div class="form-group">
                    <label for="departureTime">å‡ºç™ºäºˆå®šæ™‚åˆ»</label>
                    <input type="time" id="departureTime" value="18:00" required>
                </div>

                <div class="form-group">
                    <label for="workStartTime">ä½œæ¥­é–‹å§‹æ™‚åˆ»ï¼ˆç¾å ´åˆ°ç€ï¼‰</label>
                    <input type="time" id="workStartTime" value="20:00" required>
                </div>

                <div class="form-group">
                    <label for="siteLeaveTime">ç¾å ´çµ‚äº†æ™‚åˆ»ï¼ˆç¾å ´å‡ºç™ºï¼‰</label>
                    <input type="time" id="siteLeaveTime" value="23:00" required>
                    <small style="color: #666;">â€»ç¾å ´ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è‰²ä»˜ã‘ã«ä½¿ç”¨ã—ã¾ã™</small>
                </div>

                <div class="form-group">
                    <label for="returnTime">å¸°ç¤¾äºˆå®šæ™‚åˆ»</label>
                    <input type="time" id="returnTime" value="24:00" required>
                </div>

                <div class="form-group">
                    <label for="supervisor">ç®¡ç†è€…</label>
                    <input type="text" id="supervisor" placeholder="ä¾‹: ç”°ä¸­" required>
                </div>

                <div class="form-group">
                    <label for="memberCount">è‡ªç¤¾äºˆå®šäººæ•°</label>
                    <input type="number" id="memberCount" min="1" value="4" required>
                </div>

                <h3>ä½œæ¥­ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±</h3>
                <div id="memberInputs">
                    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                </div>

                <button type="button" class="btn btn-primary" id="previewBtn">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
                <button type="button" class="btn btn-secondary" id="generatePDFBtn" style="display: none;">ğŸ“„
                    PDFç”Ÿæˆ</button>
                <button type="button" class="btn btn-secondary" id="generatePNGBtn" style="display: none;">ğŸ–¼ï¸
                    PNGç”Ÿæˆ</button>
                <button type="button" class="btn btn-secondary" id="copyForLineBtn"
                    style="display: none; background-color: #06C755;">ğŸ“‹
                    LINEæŠ•ç¨¿ç”¨ã«ã‚³ãƒ”ãƒš</button>
                <a href="../index.html" class="btn btn-back">æˆ»ã‚‹</a>
            </form>

            <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div id="previewArea" style="display: none; margin-top: 30px;">
                <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div class="alert alert-warning">
                    ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã¦ã€å•é¡Œãªã‘ã‚Œã°PDFã¾ãŸã¯PNGã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚<br>
                    â€»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã¾ã™ã€‚
                </div>
                <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæŒ¿å…¥å ´æ‰€ -->
                <div id="templateContainer"></div>
            </div>

            <!-- ç”³è«‹æ›¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆéè¡¨ç¤ºãƒ»è¤‡è£½ç”¨ï¼‰ -->
            <div id="nightShiftTemplateSource" style="display: none;">
                <!-- å†…å®¹ã¯JSã§ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        const savedData = sessionStorage.getItem('nightShiftData');
        if (savedData) {
            const data = JSON.parse(savedData);
            document.getElementById('shiftDate').value = data.shiftDate;
            document.getElementById('client').value = data.client;
            document.getElementById('siteName').value = data.siteName;
            document.getElementById('location').value = data.location;
            document.getElementById('manager').value = data.manager;
            document.getElementById('departureTime').value = data.departureTime;
            document.getElementById('workStartTime').value = data.workStartTime;
            document.getElementById('returnTime').value = data.returnTime;
            document.getElementById('supervisor').value = data.supervisor;
            document.getElementById('memberCount').value = data.memberCount;

            // siteLeaveTimeãŒãªã„å ´åˆã¯returnTimeã‹ã‚‰æ¨æ¸¬ï¼ˆ1æ™‚é–“å‰ã¨ã‹ï¼‰
            if (data.siteLeaveTime) {
                document.getElementById('siteLeaveTime').value = data.siteLeaveTime;
            } else {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å¸°ç¤¾æ™‚é–“ã®1æ™‚é–“å‰ã‚’å…¥ã‚Œã¦ãŠã
                document.getElementById('siteLeaveTime').value = data.returnTime;
            }

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            sessionStorage.removeItem('nightShiftData');
        } else {
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
            document.getElementById('shiftDate').valueAsDate = new Date();
        }

        // ãƒ¡ãƒ³ãƒãƒ¼å…¥åŠ›æ¬„ã‚’å‹•çš„ç”Ÿæˆ
        function updateMemberInputs() {
            const count = parseInt(document.getElementById('memberCount').value) || 0;
            const container = document.getElementById('memberInputs');
            const savedData = sessionStorage.getItem('nightShiftData');
            const loadedMembers = savedData ? JSON.parse(savedData).members : null;

            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'form-group';
                memberDiv.style.border = '1px solid #e0e0e0';
                memberDiv.style.padding = '15px';
                memberDiv.style.borderRadius = '8px';
                memberDiv.style.marginBottom = '10px';

                const memberData = loadedMembers && loadedMembers[i] ? loadedMembers[i] : {
                    name: '', breakTime: 0, overtime: 0, breakStart: '', breakEnd: '',
                    directReturn: false, preSiteOvertime: { hasOvertime: false }
                };

                memberDiv.innerHTML = `
                    <h4>ãƒ¡ãƒ³ãƒãƒ¼ ${i + 1}</h4>
                    <label>åå‰</label>
                    <input type="text" class="member-name" placeholder="ä¾‹: ç”°ä¸­ã•ã‚“" value="${memberData.name}" required>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="member-direct-return" ${memberData.directReturn ? 'checked' : ''}> ç›´å¸°
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin-left: 10px;">
                            <input type="checkbox" class="member-has-pre-overtime" onchange="togglePreInput(this)" 
                                ${memberData && memberData.preSiteOvertime && memberData.preSiteOvertime.hasOvertime ? 'checked' : ''}> ç¾å ´å‰æ®‹æ¥­ã‚ã‚Š
                        </label>
                    </div>

                    <!-- ç¾å ´å‰æ®‹æ¥­å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                    <div class="pre-overtime-area" style="display: ${memberData && memberData.preSiteOvertime && memberData.preSiteOvertime.hasOvertime ? 'block' : 'none'}; background: #f9f9f9; padding: 10px; margin-top: 5px; border-radius: 4px;">
                        <span style="font-size: 12px; font-weight: bold;">ç¾å ´å‰æ®‹æ¥­ï¼ˆäº‹å‹™æ‰€/å·¥å ´ï¼‰</span>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <div style="flex: 1;">
                                <label style="font-size: 11px;">é–‹å§‹</label>
                                <input type="time" class="pre-start" value="${memberData.preSiteOvertime?.startTime || ''}">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 11px;">çµ‚äº†</label>
                                <input type="time" class="pre-end" value="${memberData.preSiteOvertime?.endTime || ''}">
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <div style="flex: 1;">
                                <label style="font-size: 11px;">ä¼‘æ†©é–‹å§‹</label>
                                <input type="time" class="pre-break-start" value="${memberData.preSiteOvertime?.breakStart || ''}">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 11px;">ä¼‘æ†©çµ‚äº†</label>
                                <input type="time" class="pre-break-end" value="${memberData.preSiteOvertime?.breakEnd || ''}">
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <div style="flex: 1;">
                            <label>ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                            <input type="number" class="member-break" min="0" value="${memberData.breakTime || 0}" placeholder="ä¾‹: 60">
                        </div>
                        <div style="flex: 1;">
                            <label>æ®‹æ¥­æ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
                            <input type="number" class="member-overtime" min="0" step="0.5" value="${memberData.overtime || 0}" placeholder="ä¾‹: 2">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <div style="flex: 1;">
                            <label>ä¼‘æ†©é–‹å§‹</label>
                            <input type="time" class="member-break-start" value="${memberData.breakStart || ''}">
                        </div>
                        <div style="flex: 1;">
                            <label>ä¼‘æ†©çµ‚äº†</label>
                            <input type="time" class="member-break-end" value="${memberData.breakEnd || ''}">
                        </div>
                    </div>
                `;

                container.appendChild(memberDiv);
            }
        }

        // äººæ•°å¤‰æ›´æ™‚ã«ãƒ¡ãƒ³ãƒãƒ¼å…¥åŠ›æ¬„ã‚’æ›´æ–°
        document.getElementById('memberCount').addEventListener('change', updateMemberInputs);

        // åˆæœŸè¡¨ç¤º
        updateMemberInputs();

        // ç¾å ´å‰æ®‹æ¥­ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        window.togglePreInput = function (checkbox) {
            const area = checkbox.closest('.form-group').querySelector('.pre-overtime-area');
            area.style.display = checkbox.checked ? 'block' : 'none';
        };

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ãƒœã‚¿ãƒ³
        document.getElementById('fillSampleBtn').addEventListener('click', function () {
            document.getElementById('shiftDate').valueAsDate = new Date();
            document.getElementById('client').value = 'ã‚µãƒ³ãƒªãƒƒãƒˆå»ºè¨­';
            document.getElementById('siteName').value = 'æ¨ªæµœ CIAL ã‚¹ã‚³ãƒ¼ãƒ³';
            document.getElementById('location').value = 'æ¨ªæµœ';
            document.getElementById('manager').value = 'ç±³ç”° æ§˜';
            document.getElementById('departureTime').value = '22:30';
            document.getElementById('workStartTime').value = '23:00';
            document.getElementById('siteLeaveTime').value = '02:00'; // 26:00
            document.getElementById('returnTime').value = '02:00'; // 26:00
            document.getElementById('supervisor').value = 'ç”°ä¸­';
            document.getElementById('memberCount').value = 2;

            updateMemberInputs();

            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’åŸ‹ã‚ã‚‹
            setTimeout(() => {
                const names = ['æ˜Ÿå·', 'ç”°ä¸­'];
                const memberNames = document.querySelectorAll('.member-name');
                const memberBreaks = document.querySelectorAll('.member-break');
                const memberOvertimes = document.querySelectorAll('.member-overtime');
                const memberDirectReturns = document.querySelectorAll('.member-direct-return');
                const memberHasPre = document.querySelectorAll('.member-has-pre-overtime');
                const memberPreStarts = document.querySelectorAll('.pre-start');
                const memberPreEnds = document.querySelectorAll('.pre-end');
                const memberPreBreakStarts = document.querySelectorAll('.pre-break-start');
                const memberPreBreakEnds = document.querySelectorAll('.pre-break-end');
                const memberBreakStarts = document.querySelectorAll('.member-break-start');
                const memberBreakEnds = document.querySelectorAll('.member-break-end');

                names.forEach((name, i) => {
                    if (memberNames[i]) memberNames[i].value = name;
                    if (memberBreaks[i]) memberBreaks[i].value = 60;
                    if (memberOvertimes[i]) memberOvertimes[i].value = 8;
                    // ä¼‘æ†©æ™‚é–“ã‚’é©å½“ã«è¨­å®šï¼ˆä¾‹: 00:00 - 01:00ï¼‰
                    if (memberBreakStarts[i]) memberBreakStarts[i].value = '00:00';
                    if (memberBreakEnds[i]) memberBreakEnds[i].value = '01:00';

                    // 2äººç›®ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ç¾å ´å‰æ®‹æ¥­ã‚’è¨­å®š
                    if (i === 1) {
                        if (memberHasPre[i]) {
                            memberHasPre[i].checked = true;
                            // æ‰‹å‹•ã§è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                            const area = memberHasPre[i].closest('.form-group').querySelector('.pre-overtime-area');
                            if (area) area.style.display = 'block';
                        }
                        if (memberPreStarts[i]) memberPreStarts[i].value = '17:00';
                        if (memberPreEnds[i]) memberPreEnds[i].value = '18:00';
                        if (memberPreBreakStarts[i]) memberPreBreakStarts[i].value = '';
                        if (memberPreBreakEnds[i]) memberPreBreakEnds[i].value = '';
                    }
                });

                alert('âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¾ã—ãŸã€‚ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }, 100);
        });

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³
        document.getElementById('previewBtn').addEventListener('click', async function () {
            if (!document.getElementById('nightShiftGenerateForm').checkValidity()) {
                alert('å…¨ã¦ã®å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
            const data = collectFormData();

            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ
            await generateTemplate(data);

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            document.getElementById('previewArea').style.display = 'block';
            document.getElementById('generatePDFBtn').style.display = 'block';
            document.getElementById('generatePNGBtn').style.display = 'block';
            document.getElementById('copyForLineBtn').style.display = 'block';

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('previewArea').scrollIntoView({ behavior: 'smooth' });
        });

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        function collectFormData() {
            const members = [];
            const memberNames = document.querySelectorAll('.member-name');
            const memberBreaks = document.querySelectorAll('.member-break');
            const memberOvertimes = document.querySelectorAll('.member-overtime');
            const memberDirectReturns = document.querySelectorAll('.member-direct-return');

            const memberHasPre = document.querySelectorAll('.member-has-pre-overtime');
            const memberPreStarts = document.querySelectorAll('.pre-start');
            const memberPreEnds = document.querySelectorAll('.pre-end');
            const memberPreBreakStarts = document.querySelectorAll('.pre-break-start');
            const memberPreBreakEnds = document.querySelectorAll('.pre-break-end');

            const memberBreakStarts = document.querySelectorAll('.member-break-start');
            const memberBreakEnds = document.querySelectorAll('.member-break-end');

            memberNames.forEach((nameInput, index) => {
                members.push({
                    name: nameInput.value,
                    breakTime: parseInt(memberBreaks[index].value) || 0,
                    overtime: parseFloat(memberOvertimes[index].value) || 0,
                    directReturn: memberDirectReturns[index] ? memberDirectReturns[index].checked : false,
                    preSiteOvertime: {
                        hasOvertime: memberHasPre[index] ? memberHasPre[index].checked : false,
                        startTime: memberPreStarts[index] ? memberPreStarts[index].value : '',
                        endTime: memberPreEnds[index] ? memberPreEnds[index].value : '',
                        breakStart: memberPreBreakStarts[index] ? memberPreBreakStarts[index].value : '',
                        breakEnd: memberPreBreakEnds[index] ? memberPreBreakEnds[index].value : ''
                    },
                    breakStart: memberBreakStarts[index].value,
                    breakEnd: memberBreakEnds[index].value
                });
            });

            return {
                shiftDate: document.getElementById('shiftDate').value,
                client: document.getElementById('client').value,
                siteName: document.getElementById('siteName').value,
                location: document.getElementById('location').value,
                manager: document.getElementById('manager').value,
                departureTime: document.getElementById('departureTime').value,
                workStartTime: document.getElementById('workStartTime').value,
                siteLeaveTime: document.getElementById('siteLeaveTime').value, // è¿½åŠ 
                returnTime: document.getElementById('returnTime').value,
                supervisor: document.getElementById('supervisor').value,
                memberCount: document.getElementById('memberCount').value,
                members: members
            };
        }

        // æ™‚é–“æ–‡å­—åˆ—ã‚’åˆ†ã«å¤‰æ›ï¼ˆ17:00ã‹ã‚‰ã®çµŒéåˆ†ï¼‰
        function timeToMinutes(timeStr) {
            if (!timeStr) return -1;
            const [h, m] = timeStr.split(':').map(Number);
            let minutes = h * 60 + m;

            // 17:00ã‚’0ã¨ã™ã‚‹
            // 00:00ã€œ08:00ã¯ç¿Œæ—¥æ‰±ã„ (+24æ™‚é–“)
            // 12:00ã‚ˆã‚Šå‰ãªã‚‰ç¿Œæ—¥ã¨ã¿ãªã™ï¼ˆå¤œå‹¤ãªã®ã§ï¼‰
            if (h < 12) {
                minutes += 24 * 60;
            }

            return minutes - (17 * 60);
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç”Ÿæˆ
        async function generateTemplate(data) {
            const container = document.getElementById('templateContainer');
            container.innerHTML = '<div id="nightShiftTemplate"></div>';
            const template = document.getElementById('nightShiftTemplate');

            const date = new Date(data.shiftDate);
            const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;

            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®æ™‚é–“å¸¯ï¼ˆ17æ™‚ã€œ8æ™‚ï¼‰= 15æ™‚é–“ = 900åˆ†
            const totalMinutes = 15 * 60;
            const hours = [];
            for (let h = 17; h <= 23; h++) hours.push(h);
            for (let h = 0; h <= 8; h++) hours.push(h);

            // æ™‚é–“è¨ˆç®—
            const departureMins = timeToMinutes(data.departureTime);
            const workStartMins = timeToMinutes(data.workStartTime);
            const siteLeaveMins = timeToMinutes(data.siteLeaveTime);
            const returnMins = timeToMinutes(data.returnTime);

            // å„ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡Œã‚’ç”Ÿæˆ
            let memberTimelines = '';
            data.members.forEach((member) => {
                const overtime = member.overtime || 0;
                const breakTime = member.breakTime || 0;
                const breakStartMins = timeToMinutes(member.breakStart);
                const breakEndMins = timeToMinutes(member.breakEnd);

                // --- æ™‚é–“è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ (night-shift.htmlã«åˆã‚ã›ã‚‹) ---

                // 1. ç¾å ´å‰æ®‹æ¥­ï¼ˆäº‹å‹™æ‰€/å·¥å ´ï¼‰
                let preSiteGrossHours = 0; // ä¼‘æ†©è¾¼ã¿
                let preSiteNetHours = 0; // ä¼‘æ†©æŠœã
                let preSiteBreakMinutes = 0;

                if (member.preSiteOvertime && member.preSiteOvertime.hasOvertime) {
                    const preSiteStart = member.preSiteOvertime.startTime;
                    const preSiteEnd = member.preSiteOvertime.endTime;
                    const preSiteBreakStart = member.preSiteOvertime.breakStart;
                    const preSiteBreakEnd = member.preSiteOvertime.breakEnd;

                    if (preSiteStart && preSiteEnd) {
                        const [startH, startM] = preSiteStart.split(':').map(Number);
                        const [endH, endM] = preSiteEnd.split(':').map(Number);
                        let startMins = startH * 60 + startM;
                        let endMins = endH * 60 + endM;
                        if (endH < startH) endMins += 24 * 60; // ç¿Œæ—¥

                        const totalMins = endMins - startMins;
                        preSiteGrossHours = Math.round((totalMins / 60) * 10) / 10;

                        // ä¼‘æ†©æ™‚é–“ã‚’å¼•ã
                        let netMins = totalMins;
                        if (preSiteBreakStart && preSiteBreakEnd) {
                            const [bStartH, bStartM] = preSiteBreakStart.split(':').map(Number);
                            const [bEndH, bEndM] = preSiteBreakEnd.split(':').map(Number);
                            const breakMins = (bEndH * 60 + bEndM) - (bStartH * 60 + bStartM);
                            preSiteBreakMinutes = breakMins;
                            netMins -= breakMins;
                        }
                        preSiteNetHours = Math.round((netMins / 60) * 10) / 10;
                    }
                }

                // 2. ç¾å ´æ®‹æ¥­ï¼ˆå‡ºç™ºï½å¸°ç¤¾ã®å…¨æ™‚é–“ï¼‰
                let siteGrossHours = 0; // ä¼‘æ†©è¾¼ã¿
                let siteNetHours = 0; // ä¼‘æ†©æŠœã

                // ç¾å ´ã§ã®ä¼‘æ†©æ™‚é–“ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›å€¤ï¼‰
                const siteBreakMinutes = member.breakTime || 0;

                // å‡ºç™ºï½å¸°ç¤¾ã®å…¨æ™‚é–“
                // ç›´å¸°ã®å ´åˆã¯ç¾å ´çµ‚äº†æ™‚é–“ã¾ã§ã‚’è¨ˆç®—å¯¾è±¡ã¨ã™ã‚‹
                let calcEndTimeMins = returnMins;
                if (member.directReturn && siteLeaveMins >= 0) {
                    calcEndTimeMins = siteLeaveMins;
                }

                if (departureMins >= 0 && calcEndTimeMins >= 0) {
                    const totalMins = calcEndTimeMins - departureMins;
                    siteGrossHours = Math.round((totalMins / 60) * 10) / 10;

                    // ä¼‘æ†©æ™‚é–“ã‚’å¼•ã
                    let netMins = totalMins;
                    if (siteBreakMinutes > 0) {
                        netMins -= siteBreakMinutes;
                    }
                    siteNetHours = Math.round((netMins / 60) * 10) / 10;
                }

                // 3. åˆè¨ˆ
                const totalGrossHours = Math.round((preSiteGrossHours + siteGrossHours) * 10) / 10;
                const totalNetHours = Math.round((preSiteNetHours + siteNetHours) * 10) / 10;

                // --- ãƒãƒ¼ç”Ÿæˆ ---
                const createBar = (start, end, color) => {
                    if (start < 0 || end < 0 || start >= end) return '';
                    const left = (start / totalMinutes) * 100;
                    const width = ((end - start) / totalMinutes) * 100;
                    return `<div style="position: absolute; left: ${left}%; width: ${width}%; top: 2px; bottom: 2px; background-color: ${color}; z-index: 1;"></div>`;
                };

                // å·¥å ´/äº‹å‹™æ‰€è¡Œã®ãƒãƒ¼: ç¾å ´å‰æ®‹æ¥­
                let factoryBars = '';
                if (member.preSiteOvertime && member.preSiteOvertime.hasOvertime) {
                    const preSiteStartMins = timeToMinutes(member.preSiteOvertime.startTime);
                    const preSiteEndMins = timeToMinutes(member.preSiteOvertime.endTime);
                    if (preSiteStartMins >= 0 && preSiteEndMins >= 0) {
                        factoryBars += createBar(preSiteStartMins, preSiteEndMins, '#FFA500'); // ã‚ªãƒ¬ãƒ³ã‚¸è‰²
                    }
                }

                // ç¾å ´è¡Œã®ãƒãƒ¼: å‡ºç™ºã€œå¸°ç¤¾å…¨èˆ¬
                let siteBars = '';

                // 1. å‡ºç™º -> ä½œæ¥­é–‹å§‹ (#FFD700)
                if (departureMins >= 0 && workStartMins >= 0) {
                    siteBars += createBar(departureMins, workStartMins, '#FFD700');
                }
                // 2. ä½œæ¥­: ä½œæ¥­é–‹å§‹ -> ç¾å ´çµ‚äº† (#FFD700)
                if (workStartMins >= 0 && siteLeaveMins >= 0) {
                    siteBars += createBar(workStartMins, siteLeaveMins, '#FFD700');
                }
                // 3. ç¾å ´çµ‚äº† -> å¸°ç¤¾ (ç›´å¸°ã§ãªã„å ´åˆã®ã¿) (#FFD700)
                if (!member.directReturn && siteLeaveMins >= 0 && returnMins >= 0) {
                    siteBars += createBar(siteLeaveMins, returnMins, '#FFD700');
                }

                // ä¼‘æ†©: ä¼‘æ†©é–‹å§‹ -> ä¼‘æ†©çµ‚äº† (ç·‘è‰²ã€z-indexã‚’ä¸Šã’ã¦ä¸Šã«é‡ã­ã‚‹)
                if (breakStartMins >= 0 && breakEndMins >= 0) {
                    // ä¼‘æ†©ãƒãƒ¼ã¯z-index: 2ã§ä¸Šã«è¡¨ç¤º
                    const left = (breakStartMins / totalMinutes) * 100;
                    const width = ((breakEndMins - breakStartMins) / totalMinutes) * 100;
                    siteBars += `<div style="position: absolute; left: ${left}%; width: ${width}%; top: 2px; bottom: 2px; background-color: #90EE90; z-index: 2;"></div>`;
                }

                // æ™‚é–“è»¸ã®ç›®ç››ã‚Šç·š
                let gridLines = '';
                for (let i = 0; i <= 15; i++) {
                    const left = (i / 15) * 100;
                    gridLines += `<div style="position: absolute; left: ${left}%; top: 0; bottom: 0; border-left: 1px solid #ccc; z-index: 0;"></div>`;
                }

                // æƒ…å ±è¡¨ç¤ºç”¨æ–‡å­—åˆ—ä½œæˆ
                let timeInfo = `<span style="font-weight: bold; width: 100px; font-size: 11px;">åå‰ ${member.name}</span>`;

                // ç›´å¸°è¡¨ç¤º
                if (member.directReturn) {
                    timeInfo += `<span style="margin-left: 5px; font-size: 10px; color: #d9534f; border: 1px solid #d9534f; padding: 0 2px; border-radius: 2px;">ç›´å¸°</span>`;
                }

                // ç¾å ´å‰æ®‹æ¥­
                if (preSiteGrossHours > 0) {
                    timeInfo += `<span style="margin-left: 8px; font-size: 10px;">ç¾å ´å‰æ®‹æ¥­${preSiteGrossHours}h</span>`;
                    if (preSiteBreakMinutes > 0) {
                        timeInfo += `<span style="margin-left: 2px; font-size: 10px;">(ä¼‘${preSiteBreakMinutes}åˆ†)</span>`;
                    }
                    timeInfo += `<span style="margin-left: 2px; font-size: 10px;">æŠœ${preSiteNetHours}h</span>`;
                }

                // ç¾å ´æ®‹æ¥­
                if (siteGrossHours > 0) {
                    timeInfo += `<span style="margin-left: 8px; font-size: 10px;">ç¾å ´æ®‹æ¥­${siteGrossHours}h</span>`;
                    if (siteBreakMinutes > 0) {
                        timeInfo += `<span style="margin-left: 2px; font-size: 10px;">(ä¼‘${siteBreakMinutes}åˆ†)</span>`;
                    }
                    timeInfo += `<span style="margin-left: 2px; font-size: 10px;">æŠœ${siteNetHours}h</span>`;
                }

                // åˆè¨ˆ
                timeInfo += `<span style="margin-left: 10px; font-size: 11px; font-weight: bold;">åˆè¨ˆ${totalGrossHours}h(æŠœ${totalNetHours}h)</span>`;


                memberTimelines += `
                    <div style="margin-bottom: 25px; page-break-inside: avoid;">
                        <div style="display: flex; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #000; padding-bottom: 5px; flex-wrap: wrap;">
                            ${timeInfo}
                        </div>
                        
                        <div style="display: flex; align-items: center; height: 22px; border-bottom: 1px solid #000;">
                            <span style="width: 90px; font-size: 11px; padding-left: 5px;">å·¥å ´ äº‹å‹™æ‰€</span>
                            <div style="flex: 1; position: relative; height: 100%; border-left: 1px solid #000;">
                                ${gridLines}
                                ${factoryBars}
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; height: 22px; border-bottom: 1px solid #000;">
                            <span style="width: 90px; font-size: 11px; padding-left: 5px;">ç¾å ´</span>
                            <div style="flex: 1; position: relative; height: 100%; border-left: 1px solid #000;">
                                ${gridLines}
                                ${siteBars}
                            </div>
                        </div>
                        
                        <div style="display: flex; align-items: center; height: 18px;">
                            <span style="width: 90px; font-size: 9px;"></span>
                            <div style="flex: 1; display: flex;">
                                ${hours.map(h => `<div style="flex: 1; text-align: center; font-size: 9px;">${h}</div>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            template.innerHTML = `
                <div style="width: 100%; height: 100%; position: relative;">
                    <h2 style="text-align: center; margin-bottom: 15px; font-size: 18px; font-weight: bold;">${date.getFullYear()}å¹´ã€€å¤œå‹¤ç”³è«‹ã‚·ãƒ¼ãƒˆ</h2>
                    
                    <div style="font-size: 10px; text-align: right; margin-bottom: 8px; line-height: 1.3;">
                        ï¼Šäº‹å‰ã«E-netLINEã¸é€ã‚‹ã‚ˆã†ã«ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚<br>
                        ï¼Šèµ·ç¥¨ã¯å¸°ç¤¾æ™‚é–“ã€é€£çµ¡ã®å ´åˆã¯ç¾å ´çµ‚äº†ä¸å¯§é–“ã«ã¦
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11px;">
                        <tr>
                            <td style="padding: 5px; border: 1px solid #000; width: 11%; background: #f5f5f5;">æ—¥ä»˜</td>
                            <td style="padding: 5px; border: 1px solid #000; width: 18%;">${dateStr}</td>
                            <td style="padding: 5px; border: 1px solid #000; width: 11%; background: #f5f5f5;">å…ƒè«‹ã‘</td>
                            <td style="padding: 5px; border: 1px solid #000; width: 18%;">${data.client}</td>
                            <td style="padding: 5px; border: 1px solid #000; width: 11%; background: #f5f5f5;">æ‹…å½“è€…</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.manager}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">ç¾å ´å</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.siteName}</td>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">å ´æ‰€</td>
                            <td style="padding: 5px; border: 1px solid #000;" colspan="3">${data.location}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">å‡ºç™ºäºˆå®šæ™‚åˆ»</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.departureTime}</td>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">ä½œæ¥­é–‹å§‹æ™‚åˆ»</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.workStartTime}</td>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">å¸°ç¤¾äºˆå®šæ™‚åˆ»</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.returnTime}</td>
                        </tr>
                        <tr>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">åˆè¨ˆä½œæ¥­äºˆå®šæ™‚é–“</td>
                            <td style="padding: 5px; border: 1px solid #000;">5æ™‚é–“00åˆ†ã€œ</td>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">ç®¡ç†è€…</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.supervisor}</td>
                            <td style="padding: 5px; border: 1px solid #000; background: #f5f5f5;">è‡ªç¤¾äºˆå®šäººæ•°</td>
                            <td style="padding: 5px; border: 1px solid #000;">${data.memberCount}äºº</td>
                        </tr>
                    </table>

                    ${memberTimelines}

                    <div style="margin-top: 30px; font-size: 10px; color: #666; text-align: center; border-top: 1px solid #eee; padding-top: 10px;">
                        é€šä¿¡çŠ¶æ³ãªã©ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã¯ã€å¾“æ¥é€šã‚Šæ‰‹å…ƒã®ç”³è«‹æ›¸PDFã«è¨˜å…¥ã—ã¦å ±å‘Šã—ã¦ãã ã•ã„ã€‚
                    </div>
                </div>
            `;
        }

        // PDFç”Ÿæˆ
        document.getElementById('generatePDFBtn').addEventListener('click', async function () {
            const template = document.getElementById('nightShiftTemplate');

            try {
                window.scrollTo(0, 0);

                const canvas = await html2canvas(template, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                // A4ç¸¦å‘ã(portrait)
                const pdf = new jsPDF('p', 'mm', 'a4');

                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save('å¤œå‹¤ç”³è«‹æ›¸.pdf');

                alert('âœ… PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ PDFç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // PNGç”Ÿæˆ
        document.getElementById('generatePNGBtn').addEventListener('click', async function () {
            const template = document.getElementById('nightShiftTemplate');

            try {
                window.scrollTo(0, 0);

                const canvas = await html2canvas(template, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                });

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'å¤œå‹¤ç”³è«‹æ›¸.png';
                    a.click();
                    URL.revokeObjectURL(url);

                    alert('âœ… PNGç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                });
            } catch (error) {
                console.error('PNGç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('âŒ PNGç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });

        // LINEç”¨ã‚³ãƒ”ãƒ¼
        document.getElementById('copyForLineBtn').addEventListener('click', function () {
            const data = collectFormData();

            let text = `ã€å¤œå‹¤å ±å‘Šã€‘\n`;
            text += `ç¾å ´å: ${data.siteName}\n`;
            text += `ä½œæ¥­æ™‚é–“: ${data.workStartTime} ã€œ ${data.siteLeaveTime}\n\n`;

            data.members.forEach(member => {
                text += `${member.name}: æ—©å‡º0h æ®‹æ¥­${member.overtime}h\n`;
            });

            copyToLineAndOpen(text);
        });
    </script>
</body>

</html>