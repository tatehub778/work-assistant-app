<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ‰çµ¦ç”³è«‹</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="container">
        <nav class="nav-bar">
            <a href="../index.html">
                <span class="back-arrow">â†</span>
                æˆ»ã‚‹
            </a>
        </nav>

        <div class="form-container">
            <h1 class="page-title">ğŸ–ï¸ æœ‰çµ¦ç”³è«‹</h1>

            <form id="paidLeaveForm">
                <div class="form-group">
                    <label for="userNameSelect">æ°å <span id="leaveBalanceDisplay"
                            style="margin-left:10px; font-weight:bold; font-size:0.9em; display:none;"></span></label>
                    <select id="userNameSelect" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="startDate">é–‹å§‹æ—¥</label>
                    <input type="date" id="startDate" required>
                </div>

                <div class="form-group">
                    <label for="endDate">çµ‚äº†æ—¥</label>
                    <input type="date" id="endDate" required>
                </div>

                <div class="form-group">
                    <label for="days">æ—¥æ•°</label>
                    <select id="days" required>
                        <option value="0.5">åŠæ—¥</option>
                        <option value="1">1æ—¥</option>
                        <option value="2">2æ—¥</option>
                        <option value="3">3æ—¥</option>
                        <option value="4">4æ—¥</option>
                        <option value="5">5æ—¥</option>
                        <option value="custom">ãã®ä»–</option>
                    </select>
                </div>

                <div class="form-group" id="customDaysGroup" style="display: none;">
                    <label for="customDays">æ—¥æ•°ã‚’å…¥åŠ›</label>
                    <input type="number" id="customDays" min="0.5" step="0.5" placeholder="ä¾‹: 7">
                </div>

                <div class="form-group">
                    <label for="reason">ç†ç”±</label>
                    <select id="reason" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ç§ç”¨">ç§ç”¨</option>
                        <option value="é€šé™¢">é€šé™¢</option>
                        <option value="å®¶æ—ã®ç”¨äº‹">å®¶æ—ã®ç”¨äº‹</option>
                        <option value="å† å©šè‘¬ç¥­">å† å©šè‘¬ç¥­</option>
                        <option value="ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥">ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>

                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label for="otherReason">ç†ç”±ã®è©³ç´°</label>
                    <input type="text" id="otherReason" placeholder="ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>

                <button type="submit" class="btn btn-primary">ğŸ“‹ LINEã‚°ãƒ«ãƒ¼ãƒ—ã«æŠ•ç¨¿</button>
                <button type="button" class="btn btn-secondary" id="saveOnly">ğŸ’¾ ä¿å­˜ã®ã¿</button>
                <a href="../index.html" class="btn btn-back">æˆ»ã‚‹</a>
            </form>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã¨è¨­å®š
        function setupUserSelect() {
            const users = JSON.parse(localStorage.getItem('user_list') || '[]');
            const currentUser = localStorage.getItem('current_user');
            const select = document.getElementById('userNameSelect');

            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                select.appendChild(option);
            });

            if (currentUser) {
                if (users.includes(currentUser)) {
                    select.value = currentUser;
                } else {
                    const option = document.createElement('option');
                    option.value = currentUser;
                    option.textContent = currentUser;
                    select.appendChild(option);
                    select.value = currentUser;
                }
            }
        }

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        const today = new Date();
        document.getElementById('startDate').valueAsDate = today;
        document.getElementById('endDate').valueAsDate = today;

        let paidLeaveBalances = {};

        // æœ‰çµ¦æ®‹æ—¥æ•°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        async function loadPaidLeaveBalances() {
            try {
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ã¯ãªãã€ã‚µãƒ¼ãƒãƒ¼(GAS)ã‹ã‚‰æœ€æ–°ã‚’å–å¾—ã™ã‚‹
                // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å‰æ
                if (window.Storage && Storage.getPaidLeaveBalance) {
                    const balances = await Storage.getPaidLeaveBalance();
                    if (balances) {
                        paidLeaveBalances = balances;
                        // ã™ã§ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ãŸã‚‰è¡¨ç¤ºæ›´æ–°
                        updateBalanceDisplay();
                    }
                }
            } catch (e) {
                console.error('æœ‰çµ¦æ®‹æ—¥æ•°ã®å–å¾—ã«å¤±æ•—', e);
            }
        }

        function updateBalanceDisplay() {
            const select = document.getElementById('userNameSelect');
            const display = document.getElementById('leaveBalanceDisplay');
            const user = select.value;

            if (user && paidLeaveBalances[user] !== undefined) {
                display.textContent = `(æœ‰çµ¦æ®‹: ${paidLeaveBalances[user]}æ—¥)`;
                display.style.display = 'inline';

                // æ®‹æ—¥æ•°ã«å¿œã˜ã¦è‰²ã‚’å¤‰ãˆã‚‹ï¼ˆä¾‹ï¼š0ãªã‚‰èµ¤ï¼‰
                if (parseFloat(paidLeaveBalances[user]) <= 0) {
                    display.style.color = '#e03131';
                } else {
                    display.style.color = '#1971c2';
                }
            } else {
                display.style.display = 'none';
            }
        }

        setupUserSelect();
        loadPaidLeaveBalances();

        document.getElementById('userNameSelect').addEventListener('change', updateBalanceDisplay);

        // æ—¥æ•°ãŒã€Œãã®ä»–ã€ã®å ´åˆã€ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
        document.getElementById('days').addEventListener('change', function () {
            const customGroup = document.getElementById('customDaysGroup');
            if (this.value === 'custom') {
                customGroup.style.display = 'block';
                document.getElementById('customDays').required = true;
            } else {
                customGroup.style.display = 'none';
                document.getElementById('customDays').required = false;
            }
        });

        // ç†ç”±ãŒã€Œãã®ä»–ã€ã®å ´åˆã€è©³ç´°å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
        document.getElementById('reason').addEventListener('change', function () {
            const otherGroup = document.getElementById('otherReasonGroup');
            if (this.value === 'ãã®ä»–') {
                otherGroup.style.display = 'block';
                document.getElementById('otherReason').required = true;
            } else {
                otherGroup.style.display = 'none';
                document.getElementById('otherReason').required = false;
            }
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ï¼ˆLINEã«æŠ•ç¨¿ï¼‰
        document.getElementById('paidLeaveForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const userName = document.getElementById('userNameSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            let days = document.getElementById('days').value;
            let reason = document.getElementById('reason').value;

            if (!userName) {
                alert('æ°åã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (days === 'custom') {
                days = document.getElementById('customDays').value;
            }

            if (reason === 'ãã®ä»–') {
                reason = document.getElementById('otherReason').value;
            }

            const data = {
                userName: userName,
                startDate: startDate,
                endDate: endDate,
                days: parseFloat(days),
                reason: reason,
                category: 'æœ‰çµ¦ç”³è«‹'
            };

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveData(STORAGE_KEYS.ATTENDANCE, data);

            // LINEæŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            let lineText = `ã€æœ‰çµ¦ç”³è«‹ã€‘\næ°å: ${userName}\n`;
            if (startDate === endDate) {
                lineText += `æ—¥ä»˜: ${formatDate(startDate)}\n`;
            } else {
                lineText += `æœŸé–“: ${formatDate(startDate)} ã€œ ${formatDate(endDate)}\n`;
            }
            lineText += `æ—¥æ•°: ${days}æ—¥\nç†ç”±: ${reason}`;

            // LINEã«ã‚³ãƒ”ãƒ¼ã—ã¦é–‹ã
            copyToLineAndOpen(lineText);

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            setTimeout(() => {
                this.reset();
                const today = new Date();
                document.getElementById('startDate').valueAsDate = today;
                document.getElementById('endDate').valueAsDate = today;
            }, 1000);
        });

        // ä¿å­˜ã®ã¿
        document.getElementById('saveOnly').addEventListener('click', function () {
            const userName = document.getElementById('userNameSelect').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            let days = document.getElementById('days').value;
            let reason = document.getElementById('reason').value;

            if (days === 'custom') {
                days = document.getElementById('customDays').value || days;
            }

            if (reason === 'ãã®ä»–') {
                reason = document.getElementById('otherReason').value || reason;
            }

            if (!userName || !startDate || !endDate || !days || !reason) {
                alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const data = {
                userName: userName,
                startDate: startDate,
                endDate: endDate,
                days: parseFloat(days),
                reason: reason,
                category: 'æœ‰çµ¦ç”³è«‹'
            };

            saveData(STORAGE_KEYS.ATTENDANCE, data);
            alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');

            document.getElementById('paidLeaveForm').reset();
            const today = new Date();
            document.getElementById('startDate').valueAsDate = today;
            document.getElementById('endDate').valueAsDate = today;
        });
    </script>
</body>

</html>