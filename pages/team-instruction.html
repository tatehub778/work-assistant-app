<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤œå‹¤ãƒ¡ãƒ³ãƒãƒ¼æŒ‡ç¤º</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="container">
        <nav class="nav-bar">
            <a href="../index.html">
                <span class="back-arrow">â†</span>
                æˆ»ã‚‹
            </a>
        </nav>

        <div class="form-container">
            <h1 class="page-title">ğŸ‘¥ å¤œå‹¤ãƒ¡ãƒ³ãƒãƒ¼æŒ‡ç¤º</h1>

            <div class="form-group">
                <label for="instructionDate">å¤œå‹¤ä½œæ¥­æ—¥</label>
                <input type="date" id="instructionDate" required>
            </div>

            <div class="form-group">
                <label>ãƒ¡ãƒ³ãƒãƒ¼é¸æŠã¨æ™‚é–“æŒ‡ç¤º</label>
                <div class="alert alert-info">
                    ğŸ’¡ ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚ŒãŸãƒ¡ãƒ³ãƒãƒ¼ã®æ—©å‡ºãƒ»æ®‹æ¥­æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                </div>
            </div>

            <ul class="checkbox-list" id="memberList">
                <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
            </ul>

            <div class="form-group">
                <button type="button" class="btn btn-secondary" id="addMemberBtn">+ ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
            </div>

            <button type="button" class="btn btn-primary" id="copyToLine">ğŸ“‹ LINEã‚°ãƒ«ãƒ¼ãƒ—ã«æŠ•ç¨¿</button>
            <button type="button" class="btn btn-secondary" id="saveOnly">ğŸ’¾ ä¿å­˜ã®ã¿</button>
            <a href="../index.html" class="btn btn-back">æˆ»ã‚‹</a>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        document.getElementById('instructionDate').valueAsDate = new Date();

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒ³ãƒãƒ¼ï¼ˆLocalStorageã«ä¿å­˜ã—ã¦ã‚ã‚Œã°å¾©å…ƒï¼‰
        let members = JSON.parse(localStorage.getItem('team_members')) || [
            'ç”°ä¸­å¤ªéƒ',
            'ä½è—¤èŠ±å­',
            'éˆ´æœ¨ä¸€éƒ',
            'é«˜æ©‹æ¬¡éƒ',
            'æ¸¡è¾ºä¸‰éƒ'
        ];

        // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’æç”»
        function renderMemberList() {
            const list = document.getElementById('memberList');
            list.innerHTML = '';

            members.forEach((member, index) => {
                const li = document.createElement('li');
                li.className = 'checkbox-item';
                li.innerHTML = `
                    <input type="checkbox" id="member${index}" value="${member}">
                    <label for="member${index}">${member}</label>
                    <div class="time-inputs">
                        <input type="number" id="early${index}" min="0" max="8" step="0.5" placeholder="æ—©å‡º" title="æ—©å‡ºæ™‚é–“">
                        <input type="number" id="overtime${index}" min="0" max="8" step="0.5" placeholder="æ®‹æ¥­" title="æ®‹æ¥­æ™‚é–“">
                    </div>
                `;
                list.appendChild(li);
            });
        }

        // åˆæœŸæç”»
        renderMemberList();

        // ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ 
        document.getElementById('addMemberBtn').addEventListener('click', function () {
            const name = prompt('ãƒ¡ãƒ³ãƒãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if (name && name.trim()) {
                members.push(name.trim());
                localStorage.setItem('team_members', JSON.stringify(members));
                renderMemberList();
            }
        });

        // LINEã«æŠ•ç¨¿
        document.getElementById('copyToLine').addEventListener('click', function () {
            const date = document.getElementById('instructionDate').value;
            if (!date) {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const instructions = [];
            members.forEach((member, index) => {
                const checkbox = document.getElementById(`member${index}`);
                if (checkbox.checked) {
                    const early = document.getElementById(`early${index}`).value || 0;
                    const overtime = document.getElementById(`overtime${index}`).value || 0;

                    let instruction = `ãƒ»${member}:`;
                    const parts = [];
                    if (parseFloat(early) > 0) {
                        parts.push(`æ—©å‡º${early}æ™‚é–“`);
                    }
                    if (parseFloat(overtime) > 0) {
                        parts.push(`æ®‹æ¥­${overtime}æ™‚é–“`);
                    }
                    if (parts.length === 0) {
                        parts.push('é€šå¸¸å‹¤å‹™');
                    }
                    instruction += ' ' + parts.join('ã€');

                    instructions.push({
                        member: member,
                        early: parseFloat(early),
                        overtime: parseFloat(overtime),
                        text: instruction
                    });
                }
            });

            if (instructions.length === 0) {
                alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const data = {
                date: date,
                instructions: instructions,
                category: 'å¤œå‹¤ãƒ¡ãƒ³ãƒãƒ¼æŒ‡ç¤º'
            };
            saveData(STORAGE_KEYS.TEAM_INSTRUCTIONS, data);

            // LINEæŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            let lineText = `ã€å¤œå‹¤ä½œæ¥­ ${formatDate(date)}ã€‘\n`;
            instructions.forEach(inst => {
                lineText += inst.text + '\n';
            });

            // LINEã«ã‚³ãƒ”ãƒ¼ã—ã¦é–‹ã
            copyToLineAndOpen(lineText);
        });

        // ä¿å­˜ã®ã¿
        document.getElementById('saveOnly').addEventListener('click', function () {
            const date = document.getElementById('instructionDate').value;
            if (!date) {
                alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const instructions = [];
            members.forEach((member, index) => {
                const checkbox = document.getElementById(`member${index}`);
                if (checkbox.checked) {
                    const early = document.getElementById(`early${index}`).value || 0;
                    const overtime = document.getElementById(`overtime${index}`).value || 0;

                    instructions.push({
                        member: member,
                        early: parseFloat(early),
                        overtime: parseFloat(overtime)
                    });
                }
            });

            if (instructions.length === 0) {
                alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const data = {
                date: date,
                instructions: instructions,
                category: 'å¤œå‹¤ãƒ¡ãƒ³ãƒãƒ¼æŒ‡ç¤º'
            };
            saveData(STORAGE_KEYS.TEAM_INSTRUCTIONS, data);
            alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        });
    </script>
</body>

</html>