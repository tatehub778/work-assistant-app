<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤œå‹¤ç”³è«‹æ›¸ä¸‹æ›¸ã</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="container">
        <nav class="nav-bar">
            <a href="../index.html">
                <span class="back-arrow">â†</span>
                æˆ»ã‚‹
            </a>
        </nav>

        <div class="form-container">
            <h1 class="page-title">ğŸ“‹ å¤œå‹¤ç”³è«‹æ›¸ä¸‹æ›¸ã</h1>

            <div class="alert alert-info">
                ğŸ’¡ å¤œå‹¤æƒ…å ±ã‚’ä¸€æ™‚ä¿å­˜ã—ã€å¾Œã§PDFç”Ÿæˆãƒšãƒ¼ã‚¸ã¸å¼•ãç¶™ã’ã¾ã™
            </div>

            <div style="margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                <button class="tab-btn active" onclick="switchTab('new')" id="tabNew">æ–°è¦ä½œæˆ</button>
                <button class="tab-btn" onclick="switchTab('list')" id="tabList">ä¸‹æ›¸ãä¸€è¦§</button>
            </div>

            <!-- æ–°è¦ä½œæˆã‚¿ãƒ– -->
            <div id="contentNew" class="tab-content active">
                <form id="nightShiftForm">
                    <div class="form-group">
                        <label for="shiftDate">å¤œå‹¤æ—¥ä»˜</label>
                        <input type="date" id="shiftDate" required>
                    </div>

                    <div class="form-group">
                        <label for="client">å…ƒè«‹ã‘</label>
                        <input type="text" id="client" placeholder="ä¾‹: ã‚¨ã‚¤ã‚¸ãƒ³ã‚°æ ª" required>
                    </div>

                    <div class="form-group">
                        <label for="siteName">ç¾å ´å</label>
                        <input type="text" id="siteName" placeholder="ä¾‹: ã‚¢ãƒ¡ãƒªãƒ¼" required>
                    </div>

                    <div class="form-group">
                        <label for="location">å ´æ‰€</label>
                        <input type="text" id="location" placeholder="ä¾‹: ã‚¹ã‚¿ã‚¸ã‚ªã‚¹ã‚±ãƒ«ãƒˆãƒ³" required>
                    </div>

                    <div class="form-group">
                        <label for="manager">æ‹…å½“è€…</label>
                        <input type="text" id="manager" placeholder="ä¾‹: å°å±±æ§˜" required>
                    </div>

                    <div class="form-group">
                        <label for="departureTime">å‡ºç™ºäºˆå®šæ™‚åˆ»</label>
                        <input type="time" id="departureTime" value="18:00" required>
                    </div>

                    <div class="form-group">
                        <label for="workStartTime">ä½œæ¥­é–‹å§‹æ™‚åˆ»</label>
                        <input type="time" id="workStartTime" value="20:00" required>
                    </div>

                    <div class="form-group">
                        <label for="returnTime">å¸°ç¤¾äºˆå®šæ™‚åˆ»</label>
                        <input type="time" id="returnTime" value="24:00" required>
                    </div>

                    <div class="form-group">
                        <label for="supervisor">ç®¡ç†è€…</label>
                        <input type="text" id="supervisor" placeholder="ä¾‹: ç”°ä¸­" required>
                    </div>

                    <div class="form-group">
                        <label for="memberCount">è‡ªç¤¾äºˆå®šäººæ•°</label>
                        <input type="number" id="memberCount" min="1" value="4" required>
                    </div>

                    <h3>ä½œæ¥­ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±</h3>
                    <div id="memberInputs">
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </div>

                    <div style="margin-top: 30px; display: flex; gap: 15px;">
                        <button type="button" class="btn btn-secondary" id="saveDraftBtn">ğŸ’¾ ä¸‹æ›¸ãä¿å­˜</button>
                        <button type="button" class="btn btn-primary" id="generateBtn">â¡ï¸ ç”Ÿæˆãƒšãƒ¼ã‚¸ã¸</button>
                    </div>
                </form>
            </div>

            <!-- ä¸‹æ›¸ãä¸€è¦§ã‚¿ãƒ– -->
            <div id="contentList" class="tab-content">
                <div id="draftsList">
                    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        let editingDraftId = null;

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        document.getElementById('shiftDate').valueAsDate = new Date();

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            if (tabName === 'new') {
                document.getElementById('contentNew').classList.add('active');
                document.getElementById('tabNew').classList.add('active');
            } else {
                document.getElementById('contentList').classList.add('active');
                document.getElementById('tabList').classList.add('active');
                loadDrafts();
            }
        }

        // ãƒ¡ãƒ³ãƒãƒ¼å…¥åŠ›æ¬„ã‚’å‹•çš„ç”Ÿæˆ
        function updateMemberInputs() {
            const count = parseInt(document.getElementById('memberCount').value) || 0;
            const container = document.getElementById('memberInputs');
            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'form-group';
                memberDiv.style.border = '1px solid #e0e0e0';
                memberDiv.style.padding = '15px';
                memberDiv.style.borderRadius = '8px';
                memberDiv.style.marginBottom = '10px';

                memberDiv.innerHTML = `
                    <h4>ãƒ¡ãƒ³ãƒãƒ¼ ${i + 1}</h4>
                    <label>åå‰</label>
                    <input type="text" class="member-name" placeholder="ä¾‹: ç”°ä¸­ã•ã‚“" required>
                    
                    <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="member-direct-return"> ç›´å¸°
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; margin-left: 10px;">
                            <input type="checkbox" class="member-has-pre-overtime" onchange="togglePreInput(this)"> ç¾å ´å‰æ®‹æ¥­ã‚ã‚Š
                        </label>
                    </div>

                    <!-- ç¾å ´å‰æ®‹æ¥­å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                    <div class="pre-overtime-area" style="display: none; background: #f9f9f9; padding: 10px; margin-top: 5px; border-radius: 4px;">
                        <span style="font-size: 12px; font-weight: bold;">ç¾å ´å‰æ®‹æ¥­ï¼ˆäº‹å‹™æ‰€/å·¥å ´ï¼‰</span>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <div style="flex: 1;">
                                <label style="font-size: 11px;">é–‹å§‹</label>
                                <input type="time" class="pre-start">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 11px;">çµ‚äº†</label>
                                <input type="time" class="pre-end">
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <div style="flex: 1;">
                                <label style="font-size: 11px;">ä¼‘æ†©é–‹å§‹</label>
                                <input type="time" class="pre-break-start">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 11px;">ä¼‘æ†©çµ‚äº†</label>
                                <input type="time" class="pre-break-end">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <div style="flex: 1;">
                            <label>ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                            <input type="number" class="member-break" min="0" value="0" placeholder="ä¾‹: 60">
                        </div>
                        <div style="flex: 1;">
                            <label>æ®‹æ¥­æ™‚é–“ï¼ˆæ™‚é–“ï¼‰</label>
                            <input type="number" class="member-overtime" min="0" step="0.5" value="0" placeholder="ä¾‹: 2">
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="member-direct-return"> ç›´å¸°
                        </label>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <div style="flex: 1;">
                            <label>ä¼‘æ†©é–‹å§‹</label>
                            <input type="time" class="member-break-start">
                        </div>
                        <div style="flex: 1;">
                            <label>ä¼‘æ†©çµ‚äº†</label>
                            <input type="time" class="member-break-end">
                        </div>
                    </div>
                `;

                container.appendChild(memberDiv);
            }
        }

        // äººæ•°å¤‰æ›´æ™‚ã«ãƒ¡ãƒ³ãƒãƒ¼å…¥åŠ›æ¬„ã‚’æ›´æ–°
        document.getElementById('memberCount').addEventListener('change', updateMemberInputs);

        // åˆæœŸè¡¨ç¤º
        updateMemberInputs();

        // ç¾å ´å‰æ®‹æ¥­ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        window.togglePreInput = function (checkbox) {
            const area = checkbox.closest('.form-group').querySelector('.pre-overtime-area');
            area.style.display = checkbox.checked ? 'block' : 'none';
        };

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        function collectFormData() {
            const members = [];
            const memberNames = document.querySelectorAll('.member-name');
            const memberBreaks = document.querySelectorAll('.member-break');
            const memberOvertimes = document.querySelectorAll('.member-overtime');
            const memberDirectReturns = document.querySelectorAll('.member-direct-return');

            // ç¾å ´å‰æ®‹æ¥­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
            const memberHasPre = document.querySelectorAll('.member-has-pre-overtime');
            const memberPreStarts = document.querySelectorAll('.pre-start');
            const memberPreEnds = document.querySelectorAll('.pre-end');
            const memberPreBreakStarts = document.querySelectorAll('.pre-break-start');
            const memberPreBreakEnds = document.querySelectorAll('.pre-break-end');

            const memberBreakStarts = document.querySelectorAll('.member-break-start');
            const memberBreakEnds = document.querySelectorAll('.member-break-end');

            memberNames.forEach((nameInput, index) => {
                members.push({
                    name: nameInput.value,
                    breakTime: parseInt(memberBreaks[index].value) || 0,
                    overtime: parseFloat(memberOvertimes[index].value) || 0,
                    directReturn: memberDirectReturns[index].checked,
                    preSiteOvertime: {
                        hasOvertime: memberHasPre[index].checked,
                        startTime: memberPreStarts[index].value,
                        endTime: memberPreEnds[index].value,
                        breakStart: memberPreBreakStarts[index].value,
                        breakEnd: memberPreBreakEnds[index].value
                    },
                    breakStart: memberBreakStarts[index].value,
                    breakEnd: memberBreakEnds[index].value
                });
            });

            return {
                shiftDate: document.getElementById('shiftDate').value,
                client: document.getElementById('client').value,
                siteName: document.getElementById('siteName').value,
                location: document.getElementById('location').value,
                manager: document.getElementById('manager').value,
                departureTime: document.getElementById('departureTime').value,
                workStartTime: document.getElementById('workStartTime').value,
                returnTime: document.getElementById('returnTime').value,
                supervisor: document.getElementById('supervisor').value,
                memberCount: document.getElementById('memberCount').value,
                members: members
            };
        }

        // ä¸‹æ›¸ãä¿å­˜
        document.getElementById('saveDraftBtn').addEventListener('click', function () {
            if (!document.getElementById('nightShiftForm').checkValidity()) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const data = collectFormData();

            if (editingDraftId) {
                // æ—¢å­˜ä¸‹æ›¸ãã‚’æ›´æ–°
                updateDraft(editingDraftId, data);
                alert('âœ… ä¸‹æ›¸ãã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                editingDraftId = null;
            } else {
                // æ–°è¦ä¸‹æ›¸ãä¿å­˜
                const draftId = saveDraft(data);
                if (draftId) {
                    alert('âœ… ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                } else {
                    alert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('nightShiftForm').reset();
            document.getElementById('shiftDate').valueAsDate = new Date();
            updateMemberInputs();
        });

        // ç”³è«‹æ›¸ç”Ÿæˆï¼ˆæº–å‚™ç‰ˆ - å®Ÿéš›ã®ç”Ÿæˆãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼‰
        document.getElementById('generateBtn').addEventListener('click', function () {
            if (!document.getElementById('nightShiftForm').checkValidity()) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const data = collectFormData();

            // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ã¦ç”Ÿæˆãƒšãƒ¼ã‚¸ã¸
            sessionStorage.setItem('nightShiftData', JSON.stringify(data));
            window.location.href = 'night-shift-generate.html';
        });

        // ä¸‹æ›¸ãä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        function loadDrafts() {
            const drafts = getDrafts();
            const container = document.getElementById('draftsList');

            if (drafts.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }

            container.innerHTML = '';

            drafts.forEach(draft => {
                const card = document.createElement('div');
                card.className = 'alert alert-info';
                card.style.marginBottom = '15px';

                const date = new Date(draft.shiftDate);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${dateStr} ${draft.client} - ${draft.siteName}</strong><br>
                            <small>ä½œæˆ: ${new Date(draft.createdAt).toLocaleString('ja-JP')}</small><br>
                            <small>ãƒ¡ãƒ³ãƒãƒ¼: ${draft.memberCount}å</small>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="editDraft(${draft.id})" style="width: auto; padding: 10px 20px;">ç·¨é›†</button>
                            <button class="btn btn-primary" onclick="generateFromDraft(${draft.id})" style="width: auto; padding: 10px 20px;">ç”Ÿæˆ</button>
                            <button class="btn btn-back" onclick="deleteDraftConfirm(${draft.id})" style="width: auto; padding: 10px 20px;">å‰Šé™¤</button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // ä¸‹æ›¸ãã‚’ç·¨é›†
        function editDraft(id) {
            const draft = getDraft(id);
            if (!draft) return;

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('shiftDate').value = draft.shiftDate;
            document.getElementById('client').value = draft.client;
            document.getElementById('siteName').value = draft.siteName;
            document.getElementById('location').value = draft.location;
            document.getElementById('manager').value = draft.manager;
            document.getElementById('departureTime').value = draft.departureTime;
            document.getElementById('workStartTime').value = draft.workStartTime;
            document.getElementById('returnTime').value = draft.returnTime;
            document.getElementById('supervisor').value = draft.supervisor;
            document.getElementById('memberCount').value = draft.memberCount;

            updateMemberInputs();

            // ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’è¨­å®š
            setTimeout(() => {
                const memberNames = document.querySelectorAll('.member-name');
                const memberBreaks = document.querySelectorAll('.member-break');
                const memberOvertimes = document.querySelectorAll('.member-overtime');
                const memberDirectReturns = document.querySelectorAll('.member-direct-return');

                const memberHasPre = document.querySelectorAll('.member-has-pre-overtime');
                const memberPreStarts = document.querySelectorAll('.pre-start');
                const memberPreEnds = document.querySelectorAll('.pre-end');
                const memberPreBreakStarts = document.querySelectorAll('.pre-break-start');
                const memberPreBreakEnds = document.querySelectorAll('.pre-break-end');

                const memberBreakStarts = document.querySelectorAll('.member-break-start');
                const memberBreakEnds = document.querySelectorAll('.member-break-end');

                draft.members.forEach((member, index) => {
                    if (memberNames[index]) memberNames[index].value = member.name;
                    if (memberBreaks[index]) memberBreaks[index].value = member.breakTime || 0;
                    if (memberOvertimes[index]) memberOvertimes[index].value = member.overtime || 0;
                    if (memberDirectReturns[index]) memberDirectReturns[index].checked = member.directReturn || false;

                    if (member.preSiteOvertime) {
                        if (memberHasPre[index]) {
                            memberHasPre[index].checked = member.preSiteOvertime.hasOvertime;
                            togglePreInput(memberHasPre[index]);
                        }
                        if (memberPreStarts[index]) memberPreStarts[index].value = member.preSiteOvertime.startTime || '';
                        if (memberPreEnds[index]) memberPreEnds[index].value = member.preSiteOvertime.endTime || '';
                        if (memberPreBreakStarts[index]) memberPreBreakStarts[index].value = member.preSiteOvertime.breakStart || '';
                        if (memberPreBreakEnds[index]) memberPreBreakEnds[index].value = member.preSiteOvertime.breakEnd || '';
                    }

                    if (memberBreakStarts[index]) memberBreakStarts[index].value = member.breakStart || '';
                    if (memberBreakEnds[index]) memberBreakEnds[index].value = member.breakEnd || '';
                });
            }, 100);

            editingDraftId = id;
            switchTab('new');
        }

        // ä¸‹æ›¸ãã‹ã‚‰ç”Ÿæˆ
        function generateFromDraft(id) {
            const draft = getDraft(id);
            if (!draft) return;

            // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
            sessionStorage.setItem('nightShiftData', JSON.stringify(draft));
            window.location.href = 'night-shift-generate.html';
        }

        // ä¸‹æ›¸ãå‰Šé™¤ç¢ºèª
        function deleteDraftConfirm(id) {
            if (confirm('ã“ã®ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                deleteDraft(id);
                loadDrafts();
                alert('âœ… ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¸‹æ›¸ãä¸€è¦§ã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // ã‚¿ãƒ–ç®¡ç†ã®CSSè¿½åŠ 
            const style = document.createElement('style');
            style.textContent = `
                .tab-btn {
                    padding: 12px 24px;
                    border: none;
                    background: #f8f9fa;
                    cursor: pointer;
                    font-size: 16px;
                    transition: all 0.3s;
                    border-bottom: 3px solid transparent;
                }
                .tab-btn.active {
                    background: white;
                    border-bottom: 3px solid #4A90E2;
                    font-weight: bold;
                }
                .tab-btn:hover {
                    background: #e9ecef;
                }
                .tab-content {
                    display: none;
                }
                .tab-content.active {
                    display: block;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>

</html>