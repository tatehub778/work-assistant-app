<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…åˆ»/æ—©é€€/ä¸­æŠœã‘ç”³å‘Š</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="container">
        <nav class="nav-bar">
            <a href="../index.html">
                <span class="back-arrow">â†</span>
                æˆ»ã‚‹
            </a>
        </nav>

        <div class="form-container">
            <h1 class="page-title">ğŸ• é…åˆ»/æ—©é€€/ä¸­æŠœã‘ç”³å‘Š</h1>

            <!-- æ³¨æ„æ›¸ããƒœãƒƒã‚¯ã‚¹ -->
            <div class="notice-box">
                <h3>â– ãƒ«ãƒ¼ãƒ«</h3>
                <ul>
                    <li>ã€Œä¸­æŠœã‘1æ™‚é–“ç¨‹åº¦ã¾ã§ã€ã€Œæœç¤¼ã«é–“ã«åˆã†ç¨‹åº¦ã®é…åˆ»ã¾ã§ã€ã¯ã€å¾“æ¥é€šã‚ŠLINEã«ä¸€è¨€ã§OKã€‚<br>ã“ã¡ã‚‰ã«ã‚‚CBOã«ã‚‚è¨˜å…¥ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
                    <li>æœ‰çµ¦ã‚„ä»£ä¼‘ã¯ã€å¾“æ¥é€šã‚Šäº‹å‹™ã«å£é ­ã§è¨€ã£ã¦ã‚‚ã‚‰ã£ã¦ã‚‚ã„ã„ã§ã™ãŒã€ã§ãã‚Œã°ã”è‡ªèº«ã§ã“ã¡ã‚‰ã‹ã‚‰ç”³è«‹ã—ã¦ãã ã•ã„ã€‚</li>
                </ul>
            </div>

            <form id="lateEarlyForm">
                <div class="form-group">
                    <label for="userNameSelect">æ°å</label>
                    <select id="userNameSelect" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="type">ç¨®åˆ¥</label>
                    <select id="type" required>
                        <option value="é…åˆ»">é…åˆ»</option>
                        <option value="æ—©é€€">æ—©é€€</option>
                        <option value="ä¸­æŠœã‘">ä¸­æŠœã‘</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="date">æ—¥ä»˜</label>
                    <input type="date" id="date" required>
                </div>

                <div class="form-group">
                    <label for="minutes">æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                    <input type="number" id="minutes" min="1" placeholder="ä¾‹: 30" required>
                </div>

                <div class="form-group">
                    <label for="reason">ç†ç”±</label>
                    <select id="reason" required>
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="å¯åŠ">å¯åŠ</option>
                        <option value="é›»è»Šé…å»¶">é›»è»Šé…å»¶</option>
                        <option value="ä½“èª¿ä¸è‰¯">ä½“èª¿ä¸è‰¯</option>
                        <option value="å®¶åº­/å­ä¾›ã®äº‹æƒ…">å®¶åº­/å­ä¾›ã®äº‹æƒ…</option>
                        <option value="ç—…é™¢">ç—…é™¢</option>
                        <option value="ãã®ä»–">ãã®ä»–ï¼ˆè‡ªç”±è¨˜å…¥å¿…é ˆï¼‰</option>
                    </select>
                </div>

                <div class="form-group" id="otherReasonGroup" style="display: none;">
                    <label for="otherReason">ç†ç”±ã®è©³ç´°</label>
                    <input type="text" id="otherReason" placeholder="ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>

                <button type="submit" class="btn btn-primary">ğŸ“‹ LINEã‚°ãƒ«ãƒ¼ãƒ—ã«æŠ•ç¨¿</button>
                <button type="button" class="btn btn-secondary" id="saveOnly">ğŸ’¾ ä¿å­˜ã®ã¿</button>
                <a href="../index.html" class="btn btn-back">æˆ»ã‚‹</a>
            </form>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã¨è¨­å®š
        function setupUserSelect() {
            const users = JSON.parse(localStorage.getItem('user_list') || '[]');
            const currentUser = localStorage.getItem('current_user');
            const select = document.getElementById('userNameSelect');

            select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';

            // ãƒªã‚¹ãƒˆãŒã‚ã‚Œã°è¿½åŠ 
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                select.appendChild(option);
            });

            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªã‚¹ãƒˆã«ã‚ã‚‹å ´åˆã¯é¸æŠã€ãªã‘ã‚Œã°è¿½åŠ ã—ã¦é¸æŠ
            if (currentUser) {
                if (users.includes(currentUser)) {
                    select.value = currentUser;
                } else {
                    const option = document.createElement('option');
                    option.value = currentUser;
                    option.textContent = currentUser;
                    select.appendChild(option);
                    select.value = currentUser;
                }
            }
        }

        // åˆæœŸåŒ–
        document.getElementById('date').valueAsDate = new Date();
        setupUserSelect();

        // ç†ç”±ãŒã€Œãã®ä»–ã€ã®å ´åˆã€è©³ç´°å…¥åŠ›æ¬„ã‚’è¡¨ç¤º
        document.getElementById('reason').addEventListener('change', function () {
            const otherGroup = document.getElementById('otherReasonGroup');
            if (this.value === 'ãã®ä»–') {
                otherGroup.style.display = 'block';
                document.getElementById('otherReason').required = true;
            } else {
                otherGroup.style.display = 'none';
                document.getElementById('otherReason').required = false;
            }
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ï¼ˆLINEã«æŠ•ç¨¿ï¼‰
        document.getElementById('lateEarlyForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const userName = document.getElementById('userNameSelect').value;
            const type = document.getElementById('type').value;
            const date = document.getElementById('date').value;
            const minutes = document.getElementById('minutes').value;
            let reason = document.getElementById('reason').value;

            if (!userName) {
                alert('æ°åã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            if (reason === 'ãã®ä»–') {
                reason = document.getElementById('otherReason').value;
            }

            const data = {
                userName: userName,
                type: type,
                date: date,
                minutes: parseInt(minutes),
                reason: reason,
                category: 'é…åˆ»æ—©é€€'
            };

            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveData(STORAGE_KEYS.ATTENDANCE, data);

            // LINEæŠ•ç¨¿ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
            const lineText = `ã€${type}ç”³å‘Šã€‘\næ°å: ${userName}\næ—¥ä»˜: ${formatDate(date)}\næ™‚é–“: ${minutes}åˆ†\nç†ç”±: ${reason}`;

            // LINEã«ã‚³ãƒ”ãƒ¼ã—ã¦é–‹ã
            copyToLineAndOpen(lineText);

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            setTimeout(() => {
                this.reset();
                document.getElementById('date').valueAsDate = new Date();
                setupUserSelect(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠçŠ¶æ…‹ã‚’æˆ»ã™
            }, 1000);
        });

        // ä¿å­˜ã®ã¿
        document.getElementById('saveOnly').addEventListener('click', function () {
            const userName = document.getElementById('userNameSelect').value;
            const type = document.getElementById('type').value;
            const date = document.getElementById('date').value;
            const minutes = document.getElementById('minutes').value;
            let reason = document.getElementById('reason').value;

            if (reason === 'ãã®ä»–') {
                reason = document.getElementById('otherReason').value || reason;
            }

            if (!userName || !date || !minutes || !reason) {
                alert('å…¨ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const data = {
                userName: userName,
                type: type,
                date: date,
                minutes: parseInt(minutes),
                reason: reason,
                category: 'é…åˆ»æ—©é€€'
            };

            saveData(STORAGE_KEYS.ATTENDANCE, data);
            alert('âœ… ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');

            document.getElementById('lateEarlyForm').reset();
            document.getElementById('date').valueAsDate = new Date();
            setupUserSelect();
        });
    </script>
</body>

</html>