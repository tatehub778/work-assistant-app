<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVå‡ºåŠ›</title>
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="container">
        <nav class="nav-bar">
            <a href="../index.html">
                <span class="back-arrow">â†</span>
                æˆ»ã‚‹
            </a>
        </nav>

        <div class="form-container">
            <h1 class="page-title">ğŸ’¾ CSVå‡ºåŠ›</h1>

            <div class="alert alert-info">
                ğŸ“Œ CBOï¼ˆã‚¯ãƒ©ãƒ•ãƒˆãƒãƒ³ã‚¯ã‚ªãƒ•ã‚£ã‚¹ï¼‰ã¸ã®å…¥åŠ›ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’CSVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
            </div>

            <div style="padding: 20px; background: #f8f9fa; border-radius: 12px; margin-bottom: 20px;">
                <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 18px;">ğŸ” å‡ºåŠ›æ¡ä»¶</h3>

                <div class="form-group">
                    <label for="exportUser">ğŸ‘¤ ç¤¾å“¡ã§çµã‚Šè¾¼ã¿</label>
                    <select id="exportUser">
                        <option value="all">å…¨å“¡</option>
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </select>
                </div>

                <div class="form-group">
                    <label for="exportCategory">ğŸ“‹ å‡ºåŠ›ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                    <select id="exportCategory">
                        <option value="all">å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿</option>
                        <option value="attendance">å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼ˆé…åˆ»/æ—©é€€/æœ‰çµ¦/ä»£ä¼‘ï¼‰</option>
                        <option value="work">ä½œæ¥­ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼ˆä½œæ¥­å ±å‘Š/å¤œå‹¤ç”³è«‹/ãƒ¡ãƒ³ãƒãƒ¼æŒ‡ç¤ºï¼‰</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="exportDateFrom">ğŸ“… æœŸé–“ï¼ˆé–‹å§‹æ—¥ï¼‰</label>
                    <input type="date" id="exportDateFrom" required>
                </div>

                <div class="form-group">
                    <label for="exportDateTo">ğŸ“… æœŸé–“ï¼ˆçµ‚äº†æ—¥ï¼‰</label>
                    <input type="date" id="exportDateTo" required>
                </div>
            </div>

            <div
                style="padding: 20px; background: #e3f2fd; border-radius: 12px; margin-bottom: 20px; border: 1px solid #90caf9;">
                <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 18px;">ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ</h3>
                <p style="font-size: 0.9em; color: #555; margin-bottom: 15px;">
                    ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¶ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã‚„ã€åˆ¥ã®ç«¯æœ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã™ã‚‹å ´åˆã«ä½¿ç”¨ã—ã¾ã™ã€‚
                </p>

                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <button type="button" class="btn" style="background-color: #0288d1; color: white; flex: 1;"
                        id="downloadBackupBtn">
                        â¬‡ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜
                    </button>
                    <button type="button" class="btn" style="background-color: #7b1fa2; color: white; flex: 1;"
                        onclick="document.getElementById('restoreFile').click()">
                        â¬†ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                    </button>
                    <input type="file" id="restoreFile" accept=".json" style="display: none;">
                </div>
                <p style="font-size: 0.8em; color: #666;">â€»ã€Œãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã€ã™ã‚‹ã¨ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã«ä¸Šæ›¸ããƒ»è¿½åŠ ã•ã‚Œã¾ã™ã€‚</p>
            </div>

            <div id="recordInfo" class="alert alert-warning" style="display: none;">
                <!-- ä»¶æ•°æƒ…å ±ã‚’è¡¨ç¤º -->
            </div>

            <button type="button" class="btn btn-primary" id="exportBtn">ğŸ“¥ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button type="button" class="btn btn-secondary" id="previewBtn">ğŸ‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
            <a href="../index.html" class="btn btn-back">æˆ»ã‚‹</a>

            <div id="previewArea" style="display: none; margin-top: 30px;">
                <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <div style="overflow-x: auto;">
                    <table class="table" id="previewTable">
                        <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæœˆã®ç¯„å›²ã‚’è¨­å®š
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

        document.getElementById('exportDateFrom').valueAsDate = firstDayOfMonth;
        document.getElementById('exportDateTo').valueAsDate = lastDayOfMonth;

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’æ§‹ç¯‰
        function buildUserFilter() {
            const allData = [
                ...getData(STORAGE_KEYS.ATTENDANCE),
                ...getData(STORAGE_KEYS.WORK_REPORTS),
                ...getData(STORAGE_KEYS.NIGHT_SHIFTS),
                ...getData(STORAGE_KEYS.TEAM_INSTRUCTIONS)
            ];
            const users = new Set();

            allData.forEach(record => {
                if (record.userName) {
                    users.add(record.userName);
                }
            });

            const select = document.getElementById('exportUser');
            select.innerHTML = '<option value="all">å…¨å“¡</option>';

            Array.from(users).sort().forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                select.appendChild(option);
            });
        }

        function getDataForDateRange(startDate, endDate) {
            const allData = [
                ...getData(STORAGE_KEYS.ATTENDANCE),
                ...getData(STORAGE_KEYS.WORK_REPORTS),
                ...getData(STORAGE_KEYS.NIGHT_SHIFTS),
                ...getData(STORAGE_KEYS.TEAM_INSTRUCTIONS)
            ];

            const fromDate = new Date(startDate);
            const toDate = new Date(endDate);

            return allData.filter(item => {
                const itemDate = new Date(item.timestamp);
                const itemDateOnly = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate());
                return itemDateOnly >= fromDate && itemDateOnly <= toDate;
            });
        }

        function prepareCSVData(records, category, userName) {
            const csvData = [];

            records.forEach(record => {
                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (category === 'attendance') {
                    if (!['é…åˆ»æ—©é€€', 'æœ‰çµ¦ç”³è«‹', 'ä»£ä¼‘ç”³è«‹'].includes(record.category)) {
                        return;
                    }
                } else if (category === 'work') {
                    if (!['ä½œæ¥­å ±å‘Š', 'å¤œå‹¤ç”³è«‹', 'å¤œå‹¤ãƒ¡ãƒ³ãƒãƒ¼æŒ‡ç¤º'].includes(record.category)) {
                        return;
                    }
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                if (userName !== 'all' && record.userName !== userName) {
                    return;
                }

                const row = {
                    'ç™»éŒ²æ—¥æ™‚': new Date(record.timestamp).toLocaleString('ja-JP'),
                    'ãƒ¦ãƒ¼ã‚¶ãƒ¼å': record.userName || 'æœªè¨­å®š',
                    'ã‚«ãƒ†ã‚´ãƒªãƒ¼': record.category,
                    'æ—¥ä»˜': '',
                    'å†…å®¹': '',
                    'è©³ç´°': ''
                };

                switch (record.category) {
                    case 'é…åˆ»æ—©é€€':
                        row['æ—¥ä»˜'] = formatDate(record.date);
                        row['å†…å®¹'] = `${record.type} ${record.minutes}åˆ†`;
                        row['è©³ç´°'] = record.reason;
                        break;

                    case 'æœ‰çµ¦ç”³è«‹':
                        row['æ—¥ä»˜'] = formatDate(record.startDate);
                        row['å†…å®¹'] = `${record.days}æ—¥`;
                        row['è©³ç´°'] = record.reason;
                        break;

                    case 'ä»£ä¼‘ç”³è«‹':
                        row['æ—¥ä»˜'] = formatDate(record.leaveDate);
                        row['å†…å®¹'] = `ä¼‘æ—¥å‡ºå‹¤æ—¥: ${formatDate(record.workDate)}`;
                        row['è©³ç´°'] = record.note || '';
                        break;

                    case 'ä½œæ¥­å ±å‘Š':
                        row['æ—¥ä»˜'] = formatDate(record.workDate);
                        row['å†…å®¹'] = record.siteName;
                        row['è©³ç´°'] = record.workContent;
                        break;

                    case 'å¤œå‹¤ç”³è«‹':
                        row['æ—¥ä»˜'] = formatDate(record.shiftDate);
                        row['å†…å®¹'] = `${record.siteName} (${record.startTime}ã€œ${record.endTime})`;
                        row['è©³ç´°'] = `${record.workContent} / ãƒ¡ãƒ³ãƒãƒ¼: ${record.members}`;
                        break;

                    case 'å¤œå‹¤ãƒ¡ãƒ³ãƒãƒ¼æŒ‡ç¤º':
                        row['æ—¥ä»˜'] = formatDate(record.date);
                        row['å†…å®¹'] = `${record.instructions.length}å`;
                        row['è©³ç´°'] = record.instructions.map(i =>
                            `${i.member}(æ—©å‡º${i.early}h/æ®‹æ¥­${i.overtime}h)`
                        ).join(', ');
                        break;
                }

                csvData.push(row);
            });

            return csvData;
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        document.getElementById('previewBtn').addEventListener('click', function () {
            const startDate = document.getElementById('exportDateFrom').value;
            const endDate = document.getElementById('exportDateTo').value;
            const category = document.getElementById('exportCategory').value;
            const userName = document.getElementById('exportUser').value;

            if (!startDate || !endDate) {
                alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const records = getDataForDateRange(startDate, endDate);
            const csvData = prepareCSVData(records, category, userName);

            if (csvData.length === 0) {
                alert('è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                document.getElementById('previewArea').style.display = 'none';
                return;
            }

            // æƒ…å ±è¡¨ç¤º
            document.getElementById('recordInfo').style.display = 'block';
            document.getElementById('recordInfo').textContent = `${csvData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

            // ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
            const table = document.getElementById('previewTable');
            table.innerHTML = '';

            // ãƒ˜ãƒƒãƒ€ãƒ¼
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            const headers = ['ç™»éŒ²æ—¥æ™‚', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', 'ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'æ—¥ä»˜', 'å†…å®¹', 'è©³ç´°'];
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });

            // ãƒ‡ãƒ¼ã‚¿è¡Œ
            const tbody = table.createTBody();
            csvData.forEach(data => {
                const row = tbody.insertRow();
                headers.forEach(header => {
                    const cell = row.insertCell();
                    cell.textContent = data[header];
                });
            });

            document.getElementById('previewArea').style.display = 'block';
            document.getElementById('previewArea').scrollIntoView({ behavior: 'smooth' });
        });

        // CSVå‡ºåŠ›
        document.getElementById('exportBtn').addEventListener('click', function () {
            const startDate = document.getElementById('exportDateFrom').value;
            const endDate = document.getElementById('exportDateTo').value;
            const category = document.getElementById('exportCategory').value;
            const userName = document.getElementById('exportUser').value;

            if (!startDate || !endDate) {
                alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const records = getDataForDateRange(startDate, endDate);
            const csvData = prepareCSVData(records, category, userName);

            if (csvData.length === 0) {
                alert('è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // CSVã«å¤‰æ›
            const headers = ['ç™»éŒ²æ—¥æ™‚', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', 'ã‚«ãƒ†ã‚´ãƒªãƒ¼', 'æ—¥ä»˜', 'å†…å®¹', 'è©³ç´°'];
            const csvContent = convertToCSV(csvData, headers);

            // ãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
            let filename = 'æ¥­å‹™ãƒ‡ãƒ¼ã‚¿';
            if (userName !== 'all') {
                filename += `_${userName}`;
            }
            filename += `_${startDate}_${endDate}.csv`;

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            downloadCSV(csvContent, filename);

            alert(`âœ… ${csvData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
        });

        // åˆæœŸåŒ–
        buildUserFilter();
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        document.getElementById('downloadBackupBtn').addEventListener('click', function () {
            const jsonString = exportAllData();
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `work_assistant_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
        document.getElementById('restoreFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ããƒ»è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                e.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const result = importData(e.target.result);
                if (result.success) {
                    alert(`âœ… å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸ\n(ãƒ‡ãƒ¼ã‚¿ä»¶æ•°: ${result.count}ä»¶)`);
                    location.reload();
                } else {
                    alert(`âŒ å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ\n${result.error}`);
                }
            };
            reader.readAsText(file);
        });
    </script>
</body>

</html>